<!DOCTYPE html>
<html lang="zh-CN">
<head>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.4.2',
    exturl: false,
    sidebar: {"position":"left","display":"hide","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="介绍 Web3.js完成第五课以后，我们的僵尸 DApp 的 Solidity 合约部分就完成了。现在我们来做一个基本的网页好让你的用户能玩它。 要做到这一点，我们将使用以太坊基金发布的 JavaScript 库 —— Web3.js\.什么是 Web3.js?还记得么？以太坊网络是由节点组成的，每一个节点都包含了区块链的一份拷贝。当你想要调用一份智能合约的一个方法，你需要从其中一个节点中查找并告">
<meta name="keywords" content="web3.js">
<meta property="og:type" content="article">
<meta property="og:title" content="web3.js">
<meta property="og:url" content="http:&#x2F;&#x2F;lisongbai.top&#x2F;2020&#x2F;06&#x2F;30&#x2F;web3-js&#x2F;index.html">
<meta property="og:site_name" content="小李の博客">
<meta property="og:description" content="介绍 Web3.js完成第五课以后，我们的僵尸 DApp 的 Solidity 合约部分就完成了。现在我们来做一个基本的网页好让你的用户能玩它。 要做到这一点，我们将使用以太坊基金发布的 JavaScript 库 —— Web3.js\.什么是 Web3.js?还记得么？以太坊网络是由节点组成的，每一个节点都包含了区块链的一份拷贝。当你想要调用一份智能合约的一个方法，你需要从其中一个节点中查找并告">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;06&#x2F;30&#x2F;HMZXOmk7bAvPoIS.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;06&#x2F;30&#x2F;k35KTEDdXcHyVzM.png">
<meta property="og:updated_time" content="2020-06-30T06:44:35.723Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;06&#x2F;30&#x2F;HMZXOmk7bAvPoIS.png">

<link rel="canonical" href="http://lisongbai.top/2020/06/30/web3-js/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>web3.js | 小李の博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="小李の博客" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小李の博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">我有一壶酒，足以慰平生。</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/yym08090809" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lisongbai.top/2020/06/30/web3-js/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李松柏">
      <meta itemprop="description" content="记录学习的技能和遇到的问题">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小李の博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          web3.js
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-06-30 00:03:22 / 修改时间：14:44:35" itemprop="dateCreated datePublished" datetime="2020-06-30T00:03:22+08:00">2020-06-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solidity-Path/" itemprop="url" rel="index">
                    <span itemprop="name">Solidity Path</span>
                  </a>
                </span>
            </span>

          
            <span id="/2020/06/30/web3-js/" class="post-meta-item leancloud_visitors" data-flag-title="web3.js" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2020/06/30/web3-js/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/06/30/web3-js/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="介绍-Web3-js"><a href="#介绍-Web3-js" class="headerlink" title="介绍 Web3.js"></a>介绍 Web3.js</h1><p>完成第五课以后，我们的僵尸 DApp 的 Solidity 合约部分就完成了。现在我们来做一个基本的网页好让你的用户能玩它。 要做到这一点，我们将使用以太坊基金发布的 JavaScript 库 —— <strong><em>Web3.js\</em></strong>.</p><h2 id="什么是-Web3-js"><a href="#什么是-Web3-js" class="headerlink" title="什么是 Web3.js?"></a>什么是 Web3.js?</h2><p>还记得么？以太坊网络是由节点组成的，每一个节点都包含了区块链的一份拷贝。当你想要调用一份智能合约的一个方法，你需要从其中一个节点中查找并告诉它:</p><a id="more"></a>

<ol>
<li>智能合约的地址</li>
<li>你想调用的方法，以及</li>
<li>你想传入那个方法的参数</li>
</ol>
<p>以太坊节点只能识别一种叫做 <strong><em>JSON-RPC\</em></strong> 的语言。这种语言直接读起来并不好懂。当你你想调用一个合约的方法的时候，需要发送的查询语句将会是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 哈……祝你写所有这样的函数调用的时候都一次通过</span><br><span class="line">// 往右边拉…… ==&gt;</span><br><span class="line">&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;eth_sendTransaction&quot;,&quot;params&quot;:[&#123;&quot;from&quot;:&quot;0xb60e8dd61c5d32be8058bb8eb970870f07233155&quot;,&quot;to&quot;:&quot;0xd46e8dd67c5d32be8058bb8eb970870f07244567&quot;,&quot;gas&quot;:&quot;0x76c0&quot;,&quot;gasPrice&quot;:&quot;0x9184e72a000&quot;,&quot;value&quot;:&quot;0x9184e72a&quot;,&quot;data&quot;:&quot;0xd46e8dd67c5d32be8d46e8dd67c5d32be8058bb8eb970870f072445675058bb8eb970870f072445675&quot;&#125;],&quot;id&quot;:1&#125;</span><br></pre></td></tr></table></figure>

<p>幸运的是 Web3.js 把这些令人讨厌的查询语句都隐藏起来了， 所以你只需要与方便易懂的 JavaScript 界面进行交互即可。</p>
<p>你不需要构建上面的查询语句，在你的代码中调用一个函数看起来将是这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CryptoZombies.methods.createRandomZombie(&quot;Vitalik Nakamoto 🤔&quot;)</span><br><span class="line">  .send(&#123; from: &quot;0xb60e8dd61c5d32be8058bb8eb970870f07233155&quot;, gas: &quot;3000000&quot; &#125;)</span><br></pre></td></tr></table></figure>

<p>我们将在接下来的几章详细解释这些语句，不过首先我们来把 Web3.js 环境搭建起来。</p>
<h2 id="准备好了么？"><a href="#准备好了么？" class="headerlink" title="准备好了么？"></a>准备好了么？</h2><p>取决于你的项目工作流程和你的爱好，你可以用一些常用工具把 Web3.js 添加进来：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 用 NPM</span><br><span class="line">npm install web3</span><br><span class="line"></span><br><span class="line">// 用 Yarn</span><br><span class="line">yarn add web3</span><br><span class="line"></span><br><span class="line">// 用 Bower</span><br><span class="line">bower install web3</span><br><span class="line"></span><br><span class="line">// ...或者其他。</span><br></pre></td></tr></table></figure>

<p>甚至，你可以从 <a href="https://github.com/ethereum/web3.js/blob/1.0/dist/web3.min.js" target="_blank" rel="noopener">github</a> 直接下载压缩后的 <code>.js</code> 文件 然后包含到你的项目文件中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot; src=&quot;web3.min.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>因为我们不想让你花太多在项目环境搭建上，在本教程中我们将使用上面的 <code>script</code> 标签来将 Web3.js 引入。</p>
<h2 id="实战演习"><a href="#实战演习" class="headerlink" title="实战演习"></a>实战演习</h2><p>我们为你建立了一个HTML 项目空壳 —— <code>index.html</code>。假设在和 <code>index.html</code> 同个文件夹里有一份 <code>web3.min.js</code></p>
<ol>
<li>使用上面的 <code>script</code> 标签代码把 <code>web3.js</code> 添加进去以备接下来使用。</li>
</ol>
<h2 id="页面创建"><a href="#页面创建" class="headerlink" title="页面创建"></a>页面创建</h2><p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>CryptoZombies front-end<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Include web3.js here --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"web3.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="Web3-提供者"><a href="#Web3-提供者" class="headerlink" title="Web3 提供者"></a>Web3 提供者</h1><p>太棒了。现在我们的项目中有了Web3.js, 来初始化它然后和区块链对话吧。</p>
<p>首先我们需要 <strong><em>Web3 Provider\</em></strong>.</p>
<p>要记住，以太坊是由共享同一份数据的相同拷贝的 <strong><em>节点</em></strong> 构成的。 在 Web3.js 里设置 Web3 的 <code>Provider</code>（提供者） 告诉我们的代码应该和 <strong>哪个节点</strong> 交互来处理我们的读写。这就好像在传统的 Web 应用程序中为你的 API 调用设置远程 Web 服务器的网址。</p>
<p>你可以运行你自己的以太坊节点来作为 Provider。 不过，有一个第三方的服务，可以让你的生活变得轻松点，让你不必为了给你的用户提供DApp而维护一个以太坊节点— <strong><em>Infura\</em></strong>.</p>
<h2 id="Infura"><a href="#Infura" class="headerlink" title="Infura"></a>Infura</h2><p><a href="https://infura.io/" target="_blank" rel="noopener">Infura</a> 是一个服务，它维护了很多以太坊节点并提供了一个缓存层来实现高速读取。你可以用他们的 API 来免费访问这个服务。 用 Infura 作为节点提供者，你可以不用自己运营节点就能很可靠地向以太坊发送、接收信息。</p>
<p>你可以通过这样把 Infura 作为你的 Web3 节点提供者：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var web3 = new Web3(new Web3.providers.WebsocketProvider(&quot;wss://mainnet.infura.io/ws&quot;));</span><br></pre></td></tr></table></figure>

<p>不过，因为我们的 DApp 将被很多人使用，这些用户不单会从区块链读取信息，还会向区块链 <strong><em>写</em></strong> 入信息，我们需要用一个方法让用户可以用他们的私钥给事务签名。</p>
<blockquote>
<p>注意: 以太坊 (以及通常意义上的 blockchains )使用一个公钥/私钥对来对给事务做数字签名。把它想成一个数字签名的异常安全的密码。这样当我修改区块链上的数据的时候，我可以用我的公钥来 <strong>证明</strong> 我就是签名的那个。但是因为没人知道我的私钥，所以没人能伪造我的事务。</p>
</blockquote>
<p>加密学非常复杂，所以除非你是个专家并且的确知道自己在做什么，你最好不要在你应用的前端中管理你用户的私钥。</p>
<p>不过幸运的是，你并不需要，已经有可以帮你处理这件事的服务了： <strong><em>Metamask\</em></strong>.</p>
<h2 id="Metamask"><a href="#Metamask" class="headerlink" title="Metamask"></a>Metamask</h2><p><a href="https://metamask.io/" target="_blank" rel="noopener">Metamask</a> 是 Chrome 和 Firefox 的浏览器扩展， 它能让用户安全地维护他们的以太坊账户和私钥， 并用他们的账户和使用 Web3.js 的网站互动（如果你还没用过它，你肯定会想去安装的——这样你的浏览器就能使用 Web3.js 了，然后你就可以和任何与以太坊区块链通信的网站交互了）</p>
<p>作为开发者，如果你想让用户从他们的浏览器里通过网站和你的DApp交互（就像我们在 CryptoZombies 游戏里一样），你肯定会想要兼容 Metamask 的。</p>
<blockquote>
<p><strong>注意</strong>: Metamask 默认使用 Infura 的服务器做为 web3 提供者。 就像我们上面做的那样。不过它还为用户提供了选择他们自己 Web3 提供者的选项。所以使用 Metamask 的 web3 提供者，你就给了用户选择权，而自己无需操心这一块。</p>
</blockquote>
<h2 id="使用-Metamask-的-web3-提供者"><a href="#使用-Metamask-的-web3-提供者" class="headerlink" title="使用 Metamask 的 web3 提供者"></a>使用 Metamask 的 web3 提供者</h2><p>Metamask 把它的 web3 提供者注入到浏览器的全局 JavaScript对象<code>web3</code>中。所以你的应用可以检查 <code>web3</code> 是否存在。若存在就使用 <code>web3.currentProvider</code> 作为它的提供者。</p>
<p>这里是一些 Metamask 提供的示例代码，用来检查用户是否安装了MetaMask，如果没有安装就告诉用户需要安装MetaMask来使用我们的应用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">window.addEventListener(&apos;load&apos;, function() &#123;</span><br><span class="line"></span><br><span class="line">  // 检查web3是否已经注入到(Mist/MetaMask)</span><br><span class="line">  if (typeof web3 !== &apos;undefined&apos;) &#123;</span><br><span class="line">    // 使用 Mist/MetaMask 的提供者</span><br><span class="line">    web3js = new Web3(web3.currentProvider);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // 处理用户没安装的情况， 比如显示一个消息</span><br><span class="line">    // 告诉他们要安装 MetaMask 来使用我们的应用</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 现在你可以启动你的应用并自由访问 Web3.js:</span><br><span class="line">  startApp()</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>你可以在你所有的应用中使用这段样板代码，好检查用户是否安装以及告诉用户安装 MetaMask。</p>
<blockquote>
<p>注意: 除了MetaMask，你的用户也可能在使用其他他的私钥管理应用，比如 <strong>Mist</strong> 浏览器。不过，它们都实现了相同的模式来注入 <code>web3</code> 变量。所以我这里描述的方法对两者是通用的。</p>
</blockquote>
<h2 id="实战演习-1"><a href="#实战演习-1" class="headerlink" title="实战演习"></a>实战演习</h2><p>我们在HTML文件中的 <code>&lt;/body&gt;</code> 标签前面放置了一个空的 <code>script</code> 标签。可以把这节课的 JavaScript 代码写在里面。</p>
<ol>
<li>把上面用来检测 MetaMask 是否安装的模板代码粘贴进来。请粘贴到以 <code>window.addEventListener</code> 开头的代码块中。</li>
</ol>
<h2 id="页面修改"><a href="#页面修改" class="headerlink" title="页面修改"></a>页面修改</h2><p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>CryptoZombies front-end<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"web3.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">      <span class="comment">// Start here</span></span></span><br><span class="line"><span class="javascript">      <span class="built_in">window</span>.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">  <span class="comment">// 检查web3是否已经注入到(Mist/MetaMask)</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">if</span> (<span class="keyword">typeof</span> web3 !== <span class="string">'undefined'</span>) &#123;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 使用 Mist/MetaMask 的提供者</span></span></span><br><span class="line"><span class="actionscript">    web3js = <span class="keyword">new</span> Web3(web3.currentProvider);</span></span><br><span class="line"><span class="actionscript">  &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 处理用户没安装的情况， 比如显示一个消息</span></span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 告诉他们要安装 MetaMask 来使用我们的应用</span></span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">  <span class="comment">// 现在你可以启动你的应用并自由访问 Web3.js:</span></span></span><br><span class="line">  startApp()</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="和合约对话"><a href="#和合约对话" class="headerlink" title="和合约对话"></a>和合约对话</h1><p>现在，我们已经用 MetaMask 的 Web3 提供者初始化了 Web3.js。接下来就让它和我们的智能合约对话吧。</p>
<p>Web3.js 需要两个东西来和你的合约对话: 它的 <strong><em>地址</em></strong> 和它的 <strong><em>ABI\</em></strong>。</p>
<h2 id="合约地址"><a href="#合约地址" class="headerlink" title="合约地址"></a>合约地址</h2><p>在你写完了你的智能合约后，你需要编译它并把它部署到以太坊。我们将在<strong>下一课</strong>中详述<strong>部署</strong>，因为它和写代码是截然不同的过程，所以我们决定打乱顺序，先来讲 Web3.js。</p>
<p>在你部署智能合约以后，它将获得一个以太坊上的永久地址。如果你还记得第二课，CryptoKitties 在以太坊上的地址是 <code>0x06012c8cf97BEaD5deAe237070F9587f8E7A266d</code>。</p>
<p>你需要在部署后复制这个地址以来和你的智能合约对话。</p>
<h2 id="合约-ABI"><a href="#合约-ABI" class="headerlink" title="合约 ABI"></a>合约 ABI</h2><p>另一个 Web3.js 为了要和你的智能合约对话而需要的东西是 <strong><em>ABI\</em></strong>。</p>
<p>ABI 意为应用二进制接口（Application Binary Interface）。 基本上，它是以 JSON 格式表示合约的方法，告诉 Web3.js 如何以合同理解的方式格式化函数调用。</p>
<p>当你编译你的合约向以太坊部署时(我们将在第七课详述)， Solidity 编译器会给你 ABI，所以除了合约地址，你还需要把这个也复制下来。</p>
<p>因为我们这一课不会讲述部署，所以现在我们已经帮你编译了 ABI 并放在了名为<code>cryptozombies_abi.js</code>，文件中，保存在一个名为 <code>cryptoZombiesABI</code> 的变量中。</p>
<p>如果我们将<code>cryptozombies_abi.js</code> 包含进我们的项目，我们就能通过那个变量访问 CryptoZombies ABI 。</p>
<h2 id="实例化-Web3-js"><a href="#实例化-Web3-js" class="headerlink" title="实例化 Web3.js"></a>实例化 Web3.js</h2><p>一旦你有了合约的地址和 ABI，你可以像这样来实例化 Web3.js。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 实例化 myContract</span><br><span class="line">var myContract = new web3js.eth.Contract(myABI, myContractAddress);</span><br></pre></td></tr></table></figure>

<h2 id="实战演习-2"><a href="#实战演习-2" class="headerlink" title="实战演习"></a>实战演习</h2><ol>
<li>在文件的 <code>&lt;head&gt;</code> 标签块中，用 <code>script</code> 标签引入<code>cryptozombies_abi.js</code>，好把 ABI 的定义引入项目。</li>
<li>在 <code>&lt;body&gt;</code> 里的 <code>&lt;script&gt;</code> 开头 , 定义一个<code>var</code>，取名 <code>cryptoZombies</code>， 不过不要对其赋值，稍后我们将用这个这个变量来存储我们实例化合约。</li>
<li>接下来，创建一个名为 <code>startApp()</code> 的 <code>function</code>。 接下来两步来完成这个方法。</li>
<li><code>startApp()</code> 里应该做的第一件事是定义一个名为<code>cryptoZombiesAddress</code> 的变量并赋值为<code>&quot;你的合约地址&quot;</code> (这是你的合约在以太坊主网上的地址)。</li>
<li>最后，来实例化我们的合约。模仿我们上面的代码，将 <code>cryptoZombies</code> 赋值为 <code>new</code> <code>web3js.eth.Contract</code> (使用我们上面代码中通过 <code>script</code> 引入的 <code>cryptoZombiesABI</code> 和 <code>cryptoZombiesAddress</code>)。</li>
</ol>
<h2 id="页面修改-1"><a href="#页面修改-1" class="headerlink" title="页面修改"></a>页面修改</h2><p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>CryptoZombies front-end<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"web3.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">     <span class="comment">&lt;!-- Include cryptozombies_abi.js here --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"cryptozombies_abi.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">      <span class="comment">// 2. Start code here</span></span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> cryptoZombies;</span></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">startApp</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> cryptoZombiesAddress = <span class="string">"你的合约地址"</span>;</span></span><br><span class="line"><span class="actionscript">        cryptoZombies = <span class="keyword">new</span> web3js.eth.Contract(cryptoZombiesABI,cryptoZombiesAddress);</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">      <span class="built_in">window</span>.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// Checking if Web3 has been injected by the browser (Mist/MetaMask)</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">if</span> (<span class="keyword">typeof</span> web3 !== <span class="string">'undefined'</span>) &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Use Mist/MetaMask's provider</span></span></span><br><span class="line"><span class="actionscript">          web3js = <span class="keyword">new</span> Web3(web3.currentProvider);</span></span><br><span class="line"><span class="actionscript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Handle the case where the user doesn't have Metamask installed</span></span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Probably show them a message prompting them to install Metamask</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// Now you can start your app &amp; access web3 freely:</span></span></span><br><span class="line">        startApp()</span><br><span class="line"></span><br><span class="line">      &#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="调用和合约函数"><a href="#调用和合约函数" class="headerlink" title="调用和合约函数"></a>调用和合约函数</h1><p>我们的合约配置好了！现在来用 Web3.js 和它对话。</p>
<p>Web3.js 有两个方法来调用我们合约的函数: <code>call</code> and <code>send</code>.</p>
<h3 id="Call"><a href="#Call" class="headerlink" title="Call"></a>Call</h3><p><code>call</code> 用来调用 <code>view</code> 和 <code>pure</code> 函数。它只运行在本地节点，不会在区块链上创建事务。</p>
<blockquote>
<p><strong>复习:</strong> <code>view</code> 和 <code>pure</code> 函数是只读的并不会改变区块链的状态。它们也不会消耗任何gas。用户也不会被要求用MetaMask对事务签名。</p>
</blockquote>
<p>使用 Web3.js，你可以如下 <code>call</code> 一个名为<code>myMethod</code>的方法并传入一个 <code>123</code> 作为参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myContract.methods.myMethod(123).call()</span><br></pre></td></tr></table></figure>

<h3 id="Send"><a href="#Send" class="headerlink" title="Send"></a>Send</h3><p><code>send</code> 将创建一个事务并改变区块链上的数据。你需要用 <code>send</code> 来调用任何非 <code>view</code> 或者 <code>pure</code> 的函数。</p>
<blockquote>
<p><strong>注意:</strong> <code>send</code> 一个事务将要求用户支付gas，并会要求弹出对话框请求用户使用 Metamask 对事务签名。在我们使用 Metamask 作为我们的 web3 提供者的时候，所有这一切都会在我们调用 <code>send()</code> 的时候自动发生。而我们自己无需在代码中操心这一切，挺爽的吧。</p>
</blockquote>
<p>使用 Web3.js, 你可以像这样 <code>send</code> 一个事务调用<code>myMethod</code> 并传入 <code>123</code> 作为参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myContract.methods.myMethod(123).send()</span><br></pre></td></tr></table></figure>

<p>语法几乎 <code>call()</code>一模一样。</p>
<h2 id="获取僵尸数据"><a href="#获取僵尸数据" class="headerlink" title="获取僵尸数据"></a>获取僵尸数据</h2><p>来看一个使用 <code>call</code> 读取我们合约数据的真实例子</p>
<p>回忆一下，我们定义我们的僵尸数组为 <code>公开</code>(public):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Zombie[] public zombies;</span><br></pre></td></tr></table></figure>

<p>在 Solidity 里，当你定义一个 <code>public</code>变量的时候， 它将自动定义一个公开的 “getter” 同名方法， 所以如果你像要查看 id 为 <code>15</code> 的僵尸，你可以像一个函数一样调用它： <code>zombies(15)</code>.</p>
<p>这是如何在外面的前端界面中写一个 JavaScript 方法来传入一个僵尸 id，在我们的合同中查询那个僵尸并返回结果</p>
<blockquote>
<p>注意: 本课中所有的示例代码都使用 Web3.js 的 <strong>1.0 版</strong>，此版本使用的是 Promises 而不是回调函数。你在线上看到的其他教程可能还在使用老版的 Web3.js。在1.0版中，语法改变了不少。如果你从其他教程中复制代码，先确保你们使用的是相同版本的Web3.js。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function getZombieDetails(id) &#123;</span><br><span class="line">  return cryptoZombies.methods.zombies(id).call()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 调用函数并做一些其他事情</span><br><span class="line">getZombieDetails(15)</span><br><span class="line">.then(function(result) &#123;</span><br><span class="line">  console.log(&quot;Zombie 15: &quot; + JSON.stringify(result));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>我们来看看这里都做了什么</p>
<p><code>cryptoZombies.methods.zombies(id).call()</code> 将和 Web3 提供者节点通信，告诉它返回从我们的合约中的 <code>Zombie[] public zombies</code>，<code>id</code>为传入参数的僵尸信息。</p>
<p>注意这是 <strong>异步的</strong>，就像从外部服务器中调用API。所以 Web3 在这里返回了一个 Promises. (如果你对 JavaScript的 Promises 不了解，最好先去学习一下这方面知识再继续)。</p>
<p>一旦那个 <code>promise</code> 被 <code>resolve</code>, (意味着我们从 Web3 提供者那里获得了响应)，我们的例子代码将执行 <code>then</code> 语句中的代码，在控制台打出 <code>result</code>。</p>
<p><code>result</code> 是一个像这样的 JavaScript 对象：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;H4XF13LD MORRIS&apos;S COOLER OLDER BROTHER&quot;,</span><br><span class="line">  &quot;dna&quot;: &quot;1337133713371337&quot;,</span><br><span class="line">  &quot;level&quot;: &quot;9999&quot;,</span><br><span class="line">  &quot;readyTime&quot;: &quot;1522498671&quot;,</span><br><span class="line">  &quot;winCount&quot;: &quot;999999999&quot;,</span><br><span class="line">  &quot;lossCount&quot;: &quot;0&quot; // Obviously.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以用一些前端逻辑代码来解析这个对象并在前端界面友好展示。</p>
<h2 id="实战演习-3"><a href="#实战演习-3" class="headerlink" title="实战演习"></a>实战演习</h2><p>我们已经帮你把 <code>getZombieDetails</code> 复制进了代码。</p>
<ol>
<li><p>先为<code>zombieToOwner</code> 创建一个类似的函数。如果你还记得 <code>ZombieFactory.sol</code>，我们有一个长这样的映射：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mapping (uint =&gt; address) public zombieToOwner;</span><br></pre></td></tr></table></figure>

<p>定义一个 JavaScript 方法，起名为 <code>zombieToOwner</code>。和上面的 <code>getZombieDetails</code> 类似， 它将接收一个<code>id</code> 作为参数，并返回一个 Web3.js <code>call</code> 我们合约里的<code>zombieToOwner</code> 。</p>
</li>
<li><p>之后在下面，为 <code>getZombiesByOwner</code> 定义一个方法。如果你还能记起 <code>ZombieHelper.sol</code>，这个方法定义像这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">function getZombiesByOwner(address _owner)</span><br></pre></td></tr></table></figure>

<p>我们的 <code>getZombiesByOwner</code> 方法将接收 <code>owner</code> 作为参数，并返回一个对我们函数 <code>getZombiesByOwner</code>的 Web3.js <code>call</code></p>
</li>
</ol>
<h2 id="页面修改-2"><a href="#页面修改-2" class="headerlink" title="页面修改"></a>页面修改</h2><p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>CryptoZombies front-end<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"web3.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"cryptozombies_abi.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> cryptoZombies;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">startApp</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> cryptoZombiesAddress = <span class="string">"YOUR_CONTRACT_ADDRESS"</span>;</span></span><br><span class="line"><span class="actionscript">        cryptoZombies = <span class="keyword">new</span> web3js.eth.Contract(cryptoZombiesABI, cryptoZombiesAddress);</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">getZombieDetails</span><span class="params">(id)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> cryptoZombies.methods.zombies(id).call()</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="comment">// 1. Define `zombieToOwner` here</span></span></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">zombieToOwner</span><span class="params">(id)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> cryptoZombies.methods.zombieToOwner(id).call()</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="comment">// 2. Define `getZombiesByOwner` here</span></span></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">getZombiesByOwner</span><span class="params">(owner)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> cryptoZombies.methods.getZombiesByOwner(owner).call()</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">      <span class="built_in">window</span>.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// Checking if Web3 has been injected by the browser (Mist/MetaMask)</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">if</span> (<span class="keyword">typeof</span> web3 !== <span class="string">'undefined'</span>) &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Use Mist/MetaMask's provider</span></span></span><br><span class="line"><span class="actionscript">          web3js = <span class="keyword">new</span> Web3(web3.currentProvider);</span></span><br><span class="line"><span class="actionscript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Handle the case where the user doesn't have Metamask installed</span></span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Probably show them a message prompting them to install Metamask</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// Now you can start your app &amp; access web3 freely:</span></span></span><br><span class="line">        startApp()</span><br><span class="line"></span><br><span class="line">      &#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="MetaMask-和账户"><a href="#MetaMask-和账户" class="headerlink" title="MetaMask 和账户"></a>MetaMask 和账户</h1><p>太棒了！你成功地写了一些前端代码来和你的第一个智能合约交互。</p>
<p>接下来我们综合一下——比如我们想让我们应用的首页显示用户的整个僵尸大军。</p>
<p>毫无疑问我们首先需要用 <code>getZombiesByOwner(owner)</code> 来查询当前用户的所有僵尸ID。</p>
<p>但是我们的 Solidity 合约需要 <code>owner</code> 作为 Solidity <code>address</code>。我们如何能知道应用用户的地址呢？</p>
<h2 id="获得-MetaMask中的用户账户"><a href="#获得-MetaMask中的用户账户" class="headerlink" title="获得 MetaMask中的用户账户"></a>获得 MetaMask中的用户账户</h2><p>MetaMask 允许用户在扩展中管理多个账户。</p>
<p>我们可以通过这样来获取 <code>web3</code> 变量中激活的当前账户：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var userAccount = web3.eth.accounts[0]</span><br></pre></td></tr></table></figure>

<p>因为用户可以随时在 MetaMask 中切换账户，我们的应用需要监控这个变量，一旦改变就要相应更新界面。例如，若用户的首页展示它们的僵尸大军，当他们在 MetaMask 中切换了账号，我们就需要更新页面来展示新选择的账户的僵尸大军。</p>
<p>我们可以通过 <code>setInterval</code> 方法来做:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var accountInterval = setInterval(function() &#123;</span><br><span class="line">  // 检查账户是否切换</span><br><span class="line">  if (web3.eth.accounts[0] !== userAccount) &#123;</span><br><span class="line">    userAccount = web3.eth.accounts[0];</span><br><span class="line">    // 调用一些方法来更新界面</span><br><span class="line">    updateInterface();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, 100);</span><br></pre></td></tr></table></figure>

<p>这段代码做的是，每100毫秒检查一次 <code>userAccount</code> 是否还等于 <code>web3.eth.accounts[0]</code> (比如：用户是否还激活了那个账户)。若不等，则将 当前激活用户赋值给 <code>userAccount</code>，然后调用一个函数来更新界面。</p>
<h2 id="实战演习-4"><a href="#实战演习-4" class="headerlink" title="实战演习"></a>实战演习</h2><p>我们来让应用在页面第一次加载的时候显示用户的僵尸大军，监控当前 MetaMask 中的激活账户，并在账户发生改变的时候刷新显示。</p>
<ol>
<li><p>定义一个名为<code>userAccount</code>的变量，不给任何初始值。</p>
</li>
<li><p>在 <code>startApp()</code>函数的最后，复制粘贴上面样板代码中的 <code>accountInterval</code> 方法进去。</p>
</li>
<li><p>将 <code>updateInterface();</code>替换成一个 <code>getZombiesByOwner</code> 的 <code>call</code> 函数，并传入 <code>userAccount</code>。</p>
</li>
<li><p>在 <code>getZombiesByOwner</code> 后面链式调用<code>then</code> 语句，并将返回的结果传入名为 <code>displayZombies</code> 的函数。 (语句像这样: <code>.then(displayZombies);</code>).</p>
<p>我们还没有 <code>displayZombies</code> 函数，将于下一章实现。</p>
</li>
</ol>
<h2 id="页面修改-3"><a href="#页面修改-3" class="headerlink" title="页面修改"></a>页面修改</h2><p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>CryptoZombies front-end<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"web3.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"cryptozombies_abi.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> cryptoZombies;</span></span><br><span class="line"><span class="actionscript">      <span class="comment">// 1. declare `userAccount` here</span></span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> userAccount;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">startApp</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> cryptoZombiesAddress = <span class="string">"YOUR_CONTRACT_ADDRESS"</span>;</span></span><br><span class="line"><span class="actionscript">        cryptoZombies = <span class="keyword">new</span> web3js.eth.Contract(cryptoZombiesABI, cryptoZombiesAddress);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// 2. Create `setInterval` code here</span></span></span><br><span class="line"><span class="actionscript">       <span class="keyword">var</span> accountInterval = setInterval(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// 检查账户是否切换</span></span></span><br><span class="line"><span class="actionscript">          <span class="keyword">if</span> (web3.eth.accounts[<span class="number">0</span>] !== userAccount) &#123;</span></span><br><span class="line">            userAccount = web3.eth.accounts[0];</span><br><span class="line"><span class="actionscript">            <span class="comment">// 调用一些方法来更新界面</span></span></span><br><span class="line"><span class="vbscript">            getZombiesByOwner(userAccount).<span class="keyword">then</span>(displayZombies);</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, 100);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">getZombieDetails</span><span class="params">(id)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> cryptoZombies.methods.zombies(id).call()</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">zombieToOwner</span><span class="params">(id)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> cryptoZombies.methods.zombieToOwner(id).call()</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">getZombiesByOwner</span><span class="params">(owner)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> cryptoZombies.methods.getZombiesByOwner(owner).call()</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">      <span class="built_in">window</span>.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// Checking if Web3 has been injected by the browser (Mist/MetaMask)</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">if</span> (<span class="keyword">typeof</span> web3 !== <span class="string">'undefined'</span>) &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Use Mist/MetaMask's provider</span></span></span><br><span class="line"><span class="actionscript">          web3js = <span class="keyword">new</span> Web3(web3.currentProvider);</span></span><br><span class="line"><span class="actionscript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Handle the case where the user doesn't have Metamask installed</span></span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Probably show them a message prompting them to install Metamask</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// Now you can start your app &amp; access web3 freely:</span></span></span><br><span class="line">        startApp()</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">      &#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="显示僵尸大军"><a href="#显示僵尸大军" class="headerlink" title="显示僵尸大军"></a>显示僵尸大军</h1><p>如果我们不向你展示如何显示你从合约获取的数据，那这个教程就太不完整了。</p>
<p>在实际应用中，你肯定想要在应用中使用诸如 React 或 Vue.js 这样的前端框架来让你的前端开发变得轻松一些。不过要教授 React 或者 Vue.js 知识的话，就大大超出了本教程的范畴——它们本身就需要几节课甚至一整个教程来教学。</p>
<p>所以为了让 CryptoZombies.io 专注于以太坊和智能合约，我们将使用 JQuery 来做一个快速示例，展示如何解析和展示从智能合约中拿到的数据。</p>
<h2 id="显示僵尸数据-—-一个粗略的例子"><a href="#显示僵尸数据-—-一个粗略的例子" class="headerlink" title="显示僵尸数据 — 一个粗略的例子"></a>显示僵尸数据 — 一个粗略的例子</h2><p>我们已经在代码中添加了一个空的代码块 <code>&lt;div id=&quot;zombies&quot;&gt;&lt;/div&gt;</code>， 在 <code>displayZombies</code> 方法中也同样有一个。</p>
<p>回忆一下在之前章节中我们在 <code>startApp()</code> 方法内部调用了 <code>displayZombies</code> 并传入了 <code>call</code> <code>getZombiesByOwner</code> 获得的结果，它将被传入一个僵尸ID数组，像这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[0, 13, 47]</span><br></pre></td></tr></table></figure>

<p>因为我们想让我们的 <code>displayZombies</code> 方法做这些事:</p>
<ol>
<li>首先清除 <code>#zombies</code> 的内容以防里面已经有什么内容（这样当用户切换账号的时候，之前账号的僵尸大军数据就会被清除）</li>
<li>循环遍历 <code>id</code>，对每一个id调用 <code>getZombieDetails(id)</code>， 从我们的合约中获得这个僵尸的数据。</li>
<li>将获得的僵尸数据放进一个HTML模板中以格式化显示，追加进 <code>#zombies</code> 里面。</li>
</ol>
<p>再次声明，我们只用了 JQuery，没有任何模板引擎，所以会非常丑。不过这只是一个如何展示僵尸数据的示例而已。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// 在合约中查找僵尸数据，返回一个对象</span><br><span class="line">getZombieDetails(id)</span><br><span class="line">.then(function(zombie) &#123;</span><br><span class="line">  // 用 ES6 的模板语法来向HTML中注入变量</span><br><span class="line">  // 把每一个都追加进 #zombies div</span><br><span class="line">  $(&quot;#zombies&quot;).append(`&lt;div class=&quot;zombie&quot;&gt;</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &lt;li&gt;Name: $&#123;zombie.name&#125;&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;DNA: $&#123;zombie.dna&#125;&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;Level: $&#123;zombie.level&#125;&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;Wins: $&#123;zombie.winCount&#125;&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;Losses: $&#123;zombie.lossCount&#125;&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;Ready Time: $&#123;zombie.readyTime&#125;&lt;/li&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">  &lt;/div&gt;`);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="如何来展示僵尸元素呢？"><a href="#如何来展示僵尸元素呢？" class="headerlink" title="如何来展示僵尸元素呢？"></a>如何来展示僵尸元素呢？</h2><p>在上面的例子中，我们只是简单地用字符串来显示 DNA。不过在你的 DApp 中，你将需要把 DNA 转换成图片来显示你的僵尸。</p>
<p>我们通过把 DNA 字符串分割成小的字符串来做到这一点，每2位数字代表一个图片，类似这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 得到一个 1-7 的数字来表示僵尸的头:</span><br><span class="line">var head = parseInt(zombie.dna.substring(0, 2)) % 7 + 1</span><br><span class="line"></span><br><span class="line">// 我们有7张头部图片：</span><br><span class="line">var headSrc = &quot;../assets/zombieparts/head-&quot; + i + &quot;.png&quot;</span><br></pre></td></tr></table></figure>

<p>每一个模块都用 CSS 绝对定位来显示，在一个上面叠加另外一个。</p>
<p>如果你想看我们的具体实现，我们将用来展示僵尸形象的 Vue.js 模块开源了： <a href="https://github.com/loomnetwork/zombie-char-component" target="_blank" rel="noopener">点击这里</a>.</p>
<p>不过，因为那个文件中有太多行代码， 超出了本教程的讨论范围。我们依然还是使用上面超级简单的 JQuery 实现，把美化僵尸的工作作为家庭作业留给你了😉</p>
<h2 id="实战演习-5"><a href="#实战演习-5" class="headerlink" title="实战演习"></a>实战演习</h2><p>我们为你创建了一个空的 <code>displayZombies</code> 方法。来一起实现它。</p>
<ol>
<li>首先我们需要清空 <code>#zombies</code> 的内容。 用JQuery，你可以这样做： <code>$(&quot;#zombies&quot;).empty();</code>。</li>
<li>接下来，我们要循环遍历所有的 id，循环这样用： <code>for (id of ids) {</code></li>
<li>在循环内部，复制粘贴上面的代码，对每一个id调用 <code>getZombieDetails(id)</code>，然后用 <code>$(&quot;#zombies&quot;).append(...)</code> 把内容追加进我们的 HTML 里面。</li>
</ol>
<h2 id="页面修改-4"><a href="#页面修改-4" class="headerlink" title="页面修改"></a>页面修改</h2><p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>CryptoZombies front-end<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"web3.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"cryptozombies_abi.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"zombies"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> cryptoZombies;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> userAccount;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">startApp</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> cryptoZombiesAddress = <span class="string">"YOUR_CONTRACT_ADDRESS"</span>;</span></span><br><span class="line"><span class="actionscript">        cryptoZombies = <span class="keyword">new</span> web3js.eth.Contract(cryptoZombiesABI, cryptoZombiesAddress);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> accountInterval = setInterval(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Check if account has changed</span></span></span><br><span class="line"><span class="actionscript">          <span class="keyword">if</span> (web3.eth.accounts[<span class="number">0</span>] !== userAccount) &#123;</span></span><br><span class="line">            userAccount = web3.eth.accounts[0];</span><br><span class="line"><span class="actionscript">            <span class="comment">// Call a function to update the UI with the new account</span></span></span><br><span class="line">            getZombiesByOwner(userAccount)</span><br><span class="line"><span class="vbscript">            .<span class="keyword">then</span>(displayZombies);</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, 100);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">displayZombies</span><span class="params">(ids)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// Start here</span></span></span><br><span class="line"><span class="javascript">        $(<span class="string">"#zombies"</span>).empty();</span></span><br><span class="line"><span class="javascript">        <span class="keyword">for</span> (id <span class="keyword">of</span> ids) &#123;</span></span><br><span class="line"><span class="actionscript">          getZombieDetails(id).then(<span class="function"><span class="keyword">function</span><span class="params">(zombie)</span> </span>&#123;</span></span><br><span class="line"><span class="vbscript">                        $(<span class="string">"#zombies"</span>).append(`&lt;div <span class="keyword">class</span>=<span class="string">"zombie"</span>&gt;</span></span><br><span class="line"><span class="handlebars"><span class="xml">              <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>Name: $&#123;zombie.name&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>DNA: $&#123;zombie.dna&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>Level: $&#123;zombie.level&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>Wins: $&#123;zombie.winCount&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>Losses: $&#123;zombie.lossCount&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>Ready Time: $&#123;zombie.readyTime&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">              <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span>`);</span></span></span><br><span class="line">          &#125;); </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">getZombieDetails</span><span class="params">(id)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> cryptoZombies.methods.zombies(id).call()</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">zombieToOwner</span><span class="params">(id)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> cryptoZombies.methods.zombieToOwner(id).call()</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">getZombiesByOwner</span><span class="params">(owner)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> cryptoZombies.methods.getZombiesByOwner(owner).call()</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">      <span class="built_in">window</span>.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// Checking if Web3 has been injected by the browser (Mist/MetaMask)</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">if</span> (<span class="keyword">typeof</span> web3 !== <span class="string">'undefined'</span>) &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Use Mist/MetaMask's provider</span></span></span><br><span class="line"><span class="actionscript">          web3js = <span class="keyword">new</span> Web3(web3.currentProvider);</span></span><br><span class="line"><span class="actionscript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Handle the case where the user doesn't have Metamask installed</span></span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Probably show them a message prompting them to install Metamask</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// Now you can start your app &amp; access web3 freely:</span></span></span><br><span class="line">        startApp()</span><br><span class="line"></span><br><span class="line">      &#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="发送事务"><a href="#发送事务" class="headerlink" title="发送事务"></a>发送事务</h1><p>这下我们的界面能检测用户的 MetaMask 账户，并自动在首页显示它们的僵尸大军了，有没有很棒？</p>
<p>现在我们来看看用 <code>send</code> 函数来修改我们智能合约里面的数据。</p>
<p>相对 <code>call</code> 函数，<code>send</code> 函数有如下主要区别:</p>
<ol>
<li><p><code>send</code> 一个事务需要一个 <code>from</code> 地址来表明谁在调用这个函数（也就是你 Solidity 代码里的 <code>msg.sender</code> )。 我们需要这是我们 DApp 的用户，这样一来 MetaMask 才会弹出提示让他们对事务签名。</p>
</li>
<li><p><code>send</code> 一个事务将花费 gas</p>
</li>
<li><p>在用户 <code>send</code> 一个事务到该事务对区块链产生实际影响之间有一个不可忽略的延迟。这是因为我们必须等待事务被包含进一个区块里，以太坊上一个区块的时间平均下来是15秒左右。如果当前在以太坊上有大量挂起事务或者用户发送了过低的 gas 价格，我们的事务可能需要等待数个区块才能被包含进去，往往可能花费数分钟。</p>
<p>所以在我们的代码中我们需要编写逻辑来处理这部分异步特性。</p>
</li>
</ol>
<h2 id="生成一个僵尸"><a href="#生成一个僵尸" class="headerlink" title="生成一个僵尸"></a>生成一个僵尸</h2><p>我们来看一个合约中一个新用户将要调用的第一个函数: <code>createRandomZombie</code>.</p>
<p>作为复习，这里是合约中的 Solidity 代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function createRandomZombie(string _name) public &#123;</span><br><span class="line">  require(ownerZombieCount[msg.sender] == 0);</span><br><span class="line">  uint randDna = _generateRandomDna(_name);</span><br><span class="line">  randDna = randDna - randDna % 100;</span><br><span class="line">  _createZombie(_name, randDna);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是如何在用 MetaMask 在 Web3.js 中调用这个函数的示例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function createRandomZombie(name) &#123;</span><br><span class="line">  // 这将需要一段时间，所以在界面中告诉用户这一点</span><br><span class="line">  // 事务被发送出去了</span><br><span class="line">  $(&quot;#txStatus&quot;).text(&quot;正在区块链上创建僵尸，这将需要一会儿...&quot;);</span><br><span class="line">  // 把事务发送到我们的合约:</span><br><span class="line">  return cryptoZombies.methods.createRandomZombie(name)</span><br><span class="line">  .send(&#123; from: userAccount &#125;)</span><br><span class="line">  .on(&quot;receipt&quot;, function(receipt) &#123;</span><br><span class="line">    $(&quot;#txStatus&quot;).text(&quot;成功生成了 &quot; + name + &quot;!&quot;);</span><br><span class="line">    // 事务被区块链接受了，重新渲染界面</span><br><span class="line">    getZombiesByOwner(userAccount).then(displayZombies);</span><br><span class="line">  &#125;)</span><br><span class="line">  .on(&quot;error&quot;, function(error) &#123;</span><br><span class="line">    // 告诉用户合约失败了</span><br><span class="line">    $(&quot;#txStatus&quot;).text(error);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的函数 <code>send</code> 一个事务到我们的 Web3 提供者，然后链式添加一些事件监听:</p>
<ul>
<li><code>receipt</code> 将在合约被包含进以太坊区块上以后被触发，这意味着僵尸被创建并保存进我们的合约了。</li>
<li><code>error</code> 将在事务未被成功包含进区块后触发，比如用户未支付足够的 gas。我们需要在界面中通知用户事务失败以便他们可以再次尝试。</li>
</ul>
<blockquote>
<p>注意:你可以在调用 <code>send</code> 时选择指定 <code>gas</code> 和 <code>gasPrice</code>， 例如： <code>.send({ from: userAccount, gas: 3000000 })</code>。如果你不指定，MetaMask 将让用户自己选择数值。</p>
</blockquote>
<h2 id="实战演习-6"><a href="#实战演习-6" class="headerlink" title="实战演习"></a>实战演习</h2><p>我们添加了一个<code>div</code>， 指定 ID 为 <code>txStatus</code> — 这样我们可以通过更新这个 div 来通知用户事务的状态。</p>
<ol>
<li><p>在 <code>displayZombies</code>下面， 复制粘贴上面 <code>createRandomZombie</code> 的代码。</p>
</li>
<li><p>我们来实现另外一个函数 <code>feedOnKitty</code>：</p>
<p>调用 <code>feedOnKitty</code> 的逻辑几乎一样 — 我们将发送一个事务来调用这个函数，并且成功的事务会为我们创建一个僵尸，所以我们希望在成功后重新绘制界面。</p>
<p>在 <code>createRandomZombie</code> 下面复制粘贴它的代码，改动这些地方:</p>
<p>a) 给其命名为 <code>feedOnKitty</code>， 它将接收两个参数 <code>zombieId</code> 和 <code>kittyId</code></p>
<p>b) <code>#txStatus</code> 的文本内容将更新为: <code>&quot;正在吃猫咪，这将需要一会儿...&quot;</code></p>
<p>c) 让其调用我们合约里面的 <code>feedOnKitty</code> 函数并传入相同的参数</p>
<p>d) <code>#txStatus</code> 里面的的成功信息应该是 <code>&quot;吃了一只猫咪并生成了一只新僵尸！&quot;</code></p>
</li>
</ol>
<h2 id="页面修改-5"><a href="#页面修改-5" class="headerlink" title="页面修改"></a>页面修改</h2><p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>CryptoZombies front-end<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"web3.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"cryptozombies_abi.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"txStatus"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"zombies"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> cryptoZombies;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> userAccount;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">startApp</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> cryptoZombiesAddress = <span class="string">"YOUR_CONTRACT_ADDRESS"</span>;</span></span><br><span class="line"><span class="actionscript">        cryptoZombies = <span class="keyword">new</span> web3js.eth.Contract(cryptoZombiesABI, cryptoZombiesAddress);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> accountInterval = setInterval(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Check if account has changed</span></span></span><br><span class="line"><span class="actionscript">          <span class="keyword">if</span> (web3.eth.accounts[<span class="number">0</span>] !== userAccount) &#123;</span></span><br><span class="line">            userAccount = web3.eth.accounts[0];</span><br><span class="line"><span class="actionscript">            <span class="comment">// Call a function to update the UI with the new account</span></span></span><br><span class="line">            getZombiesByOwner(userAccount)</span><br><span class="line"><span class="vbscript">            .<span class="keyword">then</span>(displayZombies);</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, 100);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">displayZombies</span><span class="params">(ids)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">"#zombies"</span>).empty();</span></span><br><span class="line"><span class="javascript">        <span class="keyword">for</span> (id <span class="keyword">of</span> ids) &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Look up zombie details from our contract. Returns a `zombie` object</span></span></span><br><span class="line">          getZombieDetails(id)</span><br><span class="line"><span class="actionscript">          .then(<span class="function"><span class="keyword">function</span><span class="params">(zombie)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// Using ES6's "template literals" to inject variables into the HTML.</span></span></span><br><span class="line"><span class="actionscript">            <span class="comment">// Append each one to our #zombies div</span></span></span><br><span class="line"><span class="vbscript">            $(<span class="string">"#zombies"</span>).append(`&lt;div <span class="keyword">class</span>=<span class="string">"zombie"</span>&gt;</span></span><br><span class="line"><span class="handlebars"><span class="xml">              <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>Name: $&#123;zombie.name&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>DNA: $&#123;zombie.dna&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>Level: $&#123;zombie.level&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>Wins: $&#123;zombie.winCount&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>Losses: $&#123;zombie.lossCount&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>Ready Time: $&#123;zombie.readyTime&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">              <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span>`);</span></span></span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="comment">// Start here</span></span></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">createRandomZombie</span><span class="params">(name)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 这将需要一段时间，所以在界面中告诉用户这一点</span></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 事务被发送出去了</span></span></span><br><span class="line"><span class="javascript">  $(<span class="string">"#txStatus"</span>).text(<span class="string">"正在区块链上创建僵尸，这将需要一会儿..."</span>);</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 把事务发送到我们的合约:</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">return</span> cryptoZombies.methods.createRandomZombie(name)</span></span><br><span class="line">  .send(&#123; from: userAccount &#125;)</span><br><span class="line"><span class="actionscript">  .on(<span class="string">"receipt"</span>, <span class="function"><span class="keyword">function</span><span class="params">(receipt)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">    $(<span class="string">"#txStatus"</span>).text(<span class="string">"成功生成了 "</span> + name + <span class="string">"!"</span>);</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 事务被区块链接受了，重新渲染界面</span></span></span><br><span class="line"><span class="vbscript">    getZombiesByOwner(userAccount).<span class="keyword">then</span>(displayZombies);</span></span><br><span class="line">  &#125;)</span><br><span class="line"><span class="actionscript">  .on(<span class="string">"error"</span>, <span class="function"><span class="keyword">function</span><span class="params">(error)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 告诉用户合约失败了</span></span></span><br><span class="line"><span class="javascript">    $(<span class="string">"#txStatus"</span>).text(error);</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">feedOnKitty</span><span class="params">(zombieId, kittyId)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">  $(<span class="string">"#txStatus"</span>).text(<span class="string">"正在吃猫咪，这将需要一会儿..."</span>);</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">return</span> cryptoZombies.methods.feedOnKitty(zombieId, kittyId)</span></span><br><span class="line">  .send(&#123; from: userAccount &#125;)</span><br><span class="line"><span class="actionscript">  .on(<span class="string">"receipt"</span>, <span class="function"><span class="keyword">function</span><span class="params">(receipt)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">    $(<span class="string">"#txStatus"</span>).text(<span class="string">"吃了一只猫咪并生成了一只新僵尸！"</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">// 事务被区块链接受了，重新渲染界面</span></span></span><br><span class="line"><span class="vbscript">    getZombiesByOwner(userAccount).<span class="keyword">then</span>(displayZombies);</span></span><br><span class="line">  &#125;)</span><br><span class="line"><span class="actionscript">  .on(<span class="string">"error"</span>, <span class="function"><span class="keyword">function</span><span class="params">(error)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 告诉用户合约失败了</span></span></span><br><span class="line"><span class="javascript">    $(<span class="string">"#txStatus"</span>).text(error);</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">getZombieDetails</span><span class="params">(id)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> cryptoZombies.methods.zombies(id).call()</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">zombieToOwner</span><span class="params">(id)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> cryptoZombies.methods.zombieToOwner(id).call()</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">getZombiesByOwner</span><span class="params">(owner)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> cryptoZombies.methods.getZombiesByOwner(owner).call()</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">      <span class="built_in">window</span>.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// Checking if Web3 has been injected by the browser (Mist/MetaMask)</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">if</span> (<span class="keyword">typeof</span> web3 !== <span class="string">'undefined'</span>) &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Use Mist/MetaMask's provider</span></span></span><br><span class="line"><span class="actionscript">          web3js = <span class="keyword">new</span> Web3(web3.currentProvider);</span></span><br><span class="line"><span class="actionscript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Handle the case where the user doesn't have Metamask installed</span></span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Probably show them a message prompting them to install Metamask</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// Now you can start your app &amp; access web3 freely:</span></span></span><br><span class="line">        startApp()</span><br><span class="line"></span><br><span class="line">      &#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="调用-Payable-函数"><a href="#调用-Payable-函数" class="headerlink" title="调用 Payable 函数"></a>调用 Payable 函数</h1><p><code>attack</code>, <code>changeName</code>, 以及 <code>changeDna</code> 的逻辑将非常雷同，所以本课将不会花时间在上面。</p>
<blockquote>
<p>实际上，在调用这些函数的时候已经有了非常多的重复逻辑。所以最好是重构代码把相同的代码写成一个函数。（并对<code>txStatus</code>使用模板系统——我们已经看到用类似 Vue.js 类的框架是多么整洁）</p>
</blockquote>
<p>我们来看看另外一种 Web3.js 中需要特殊对待的函数 — <code>payable</code> 函数。</p>
<h2 id="升级！"><a href="#升级！" class="headerlink" title="升级！"></a>升级！</h2><p>回忆一下在 <code>ZombieHelper</code> 里面，我们添加了一个 payable 函数，用户可以用来升级:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function levelUp(uint _zombieId) external payable &#123;</span><br><span class="line">  require(msg.value == levelUpFee);</span><br><span class="line">  zombies[_zombieId].level++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和函数一起发送以太非常简单，只有一点需要注意： 我们需要指定发送多少 <code>wei</code>，而不是以太。</p>
<h2 id="啥是-Wei"><a href="#啥是-Wei" class="headerlink" title="啥是 Wei?"></a>啥是 Wei?</h2><p>一个 <code>wei</code> 是以太的最小单位 — 1 <code>ether</code> 等于 10^18 <code>wei</code></p>
<p>太多0要数了，不过幸运的是 Web3.js 有一个转换工具来帮我们做这件事：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 把 1 ETH 转换成 Wei</span><br><span class="line">web3js.utils.toWei(&quot;1&quot;, &quot;ether&quot;);</span><br></pre></td></tr></table></figure>

<p>在我们的 DApp 里， 我们设置了 <code>levelUpFee = 0.001 ether</code>，所以调用 <code>levelUp</code> 方法的时候，我们可以让用户用以下的代码同时发送 <code>0.001</code> 以太:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cryptoZombies.methods.levelUp(zombieId)</span><br><span class="line">.send(&#123; from: userAccount, value: web3js.utils.toWei(&quot;0.001&quot;,&quot;ether&quot;) &#125;)</span><br></pre></td></tr></table></figure>

<h2 id="实战演习-7"><a href="#实战演习-7" class="headerlink" title="实战演习"></a>实战演习</h2><p>在 <code>feedOnKitty</code> 下面添加一个 <code>levelUp</code> 方法。代码和 <code>feedOnKitty</code> 将非常相似。不过：</p>
<ol>
<li>函数将接收一个参数, <code>zombieId</code></li>
<li>在发送事务之前，<code>txStatus</code> 的文本应该是 <code>&quot;正在升级您的僵尸...&quot;</code></li>
<li>当它调用合约里的<code>levelUp</code>时，它应该发送<code>&quot;0.001&quot;</code> ETH，并用 <code>toWei</code> 转换，如同上面例子里那样。</li>
<li>成功之后应该显示 <code>&quot;不得了了！僵尸成功升级啦！&quot;</code></li>
<li>我们 <strong>不</strong> 需要在调用 <code>getZombiesByOwner</code> 后重新绘制界面 — 因为在这里我们只是修改了僵尸的级别而已。</li>
</ol>
<h2 id="页面修改-6"><a href="#页面修改-6" class="headerlink" title="页面修改"></a>页面修改</h2><p>index.html</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;CryptoZombies front-end&lt;<span class="regexp">/title&gt;</span></span><br><span class="line"><span class="regexp">    &lt;script language="javascript" type="text/</span>javascript<span class="string">" src="</span>https:<span class="comment">//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"&gt;&lt;/script&gt;</span></span><br><span class="line">    &lt;script language=<span class="string">"javascript"</span> type=<span class="string">"text/javascript"</span> src=<span class="string">"web3.min.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">    &lt;script language=<span class="string">"javascript"</span> type=<span class="string">"text/javascript"</span> src=<span class="string">"cryptozombies_abi.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">  &lt;<span class="regexp">/head&gt;</span></span><br><span class="line"><span class="regexp">  &lt;body&gt;</span></span><br><span class="line"><span class="regexp">    &lt;div id="txStatus"&gt;&lt;/</span>div&gt;</span><br><span class="line">    &lt;div id=<span class="string">"zombies"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">    &lt;script&gt;</span><br><span class="line">      <span class="keyword">var</span> cryptoZombies;</span><br><span class="line">      <span class="keyword">var</span> userAccount;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">startApp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> cryptoZombiesAddress = <span class="string">"YOUR_CONTRACT_ADDRESS"</span>;</span><br><span class="line">        cryptoZombies = <span class="keyword">new</span> web3js.eth.Contract(cryptoZombiesABI, cryptoZombiesAddress);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> accountInterval = setInterval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="comment">// Check if account has changed</span></span><br><span class="line">          <span class="keyword">if</span> (web3.eth.accounts[<span class="number">0</span>] !== userAccount) &#123;</span><br><span class="line">            userAccount = web3.eth.accounts[<span class="number">0</span>];</span><br><span class="line">            <span class="comment">// Call a function to update the UI with the new account</span></span><br><span class="line">            getZombiesByOwner(userAccount)</span><br><span class="line">            .then(displayZombies);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, <span class="number">100</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">displayZombies</span>(<span class="params">ids</span>) </span>&#123;</span><br><span class="line">        $(<span class="string">"#zombies"</span>).empty();</span><br><span class="line">        <span class="keyword">for</span> (id <span class="keyword">of</span> ids) &#123;</span><br><span class="line">          <span class="comment">// Look up zombie details from our contract. Returns a `zombie` object</span></span><br><span class="line">          getZombieDetails(id)</span><br><span class="line">          .then(<span class="function"><span class="keyword">function</span>(<span class="params">zombie</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// Using ES6's "template literals" to inject variables into the HTML.</span></span><br><span class="line">            <span class="comment">// Append each one to our #zombies div</span></span><br><span class="line">            $(<span class="string">"#zombies"</span>).append(<span class="string">`&lt;div class="zombie"&gt;</span></span><br><span class="line"><span class="string">              &lt;ul&gt;</span></span><br><span class="line"><span class="string">                &lt;li&gt;Name: <span class="subst">$&#123;zombie.name&#125;</span>&lt;/li&gt;</span></span><br><span class="line"><span class="string">                &lt;li&gt;DNA: <span class="subst">$&#123;zombie.dna&#125;</span>&lt;/li&gt;</span></span><br><span class="line"><span class="string">                &lt;li&gt;Level: <span class="subst">$&#123;zombie.level&#125;</span>&lt;/li&gt;</span></span><br><span class="line"><span class="string">                &lt;li&gt;Wins: <span class="subst">$&#123;zombie.winCount&#125;</span>&lt;/li&gt;</span></span><br><span class="line"><span class="string">                &lt;li&gt;Losses: <span class="subst">$&#123;zombie.lossCount&#125;</span>&lt;/li&gt;</span></span><br><span class="line"><span class="string">                &lt;li&gt;Ready Time: <span class="subst">$&#123;zombie.readyTime&#125;</span>&lt;/li&gt;</span></span><br><span class="line"><span class="string">              &lt;/ul&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;`</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">createRandomZombie</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// This is going to take a while, so update the UI to let the user know</span></span><br><span class="line">        <span class="comment">// the transaction has been sent</span></span><br><span class="line">        $(<span class="string">"#txStatus"</span>).text(<span class="string">"Creating new zombie on the blockchain. This may take a while..."</span>);</span><br><span class="line">        <span class="comment">// Send the tx to our contract:</span></span><br><span class="line">        <span class="keyword">return</span> cryptoZombies.methods.createRandomZombie(name)</span><br><span class="line">        .send(&#123; <span class="attr">from</span>: userAccount &#125;)</span><br><span class="line">        .on(<span class="string">"receipt"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">receipt</span>) </span>&#123;</span><br><span class="line">          $(<span class="string">"#txStatus"</span>).text(<span class="string">"Successfully created "</span> + name + <span class="string">"!"</span>);</span><br><span class="line">          <span class="comment">// Transaction was accepted into the blockchain, let's redraw the UI</span></span><br><span class="line">          getZombiesByOwner(userAccount).then(displayZombies);</span><br><span class="line">        &#125;)</span><br><span class="line">        .on(<span class="string">"error"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">          <span class="comment">// Do something to alert the user their transaction has failed</span></span><br><span class="line">          $(<span class="string">"#txStatus"</span>).text(error);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">feedOnKitty</span>(<span class="params">zombieId, kittyId</span>) </span>&#123;</span><br><span class="line">        $(<span class="string">"#txStatus"</span>).text(<span class="string">"Eating a kitty. This may take a while..."</span>);</span><br><span class="line">        <span class="keyword">return</span> cryptoZombies.methods.feedOnKitty(zombieId, kittyId)</span><br><span class="line">        .send(&#123; <span class="attr">from</span>: userAccount &#125;)</span><br><span class="line">        .on(<span class="string">"receipt"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">receipt</span>) </span>&#123;</span><br><span class="line">          $(<span class="string">"#txStatus"</span>).text(<span class="string">"Ate a kitty and spawned a new Zombie!"</span>);</span><br><span class="line">          getZombiesByOwner(userAccount).then(displayZombies);</span><br><span class="line">        &#125;)</span><br><span class="line">        .on(<span class="string">"error"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">          $(<span class="string">"#txStatus"</span>).text(error);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Start here</span></span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">levelUp</span>(<span class="params">zombieId</span>) </span>&#123;</span><br><span class="line">         $(<span class="string">"#txStatus"</span>).text(<span class="string">"正在升级您的僵尸..."</span>);</span><br><span class="line">         <span class="keyword">return</span> cryptoZombies.methods.levelUp(zombieId)</span><br><span class="line">         .send(&#123; <span class="attr">from</span>: userAccount, <span class="attr">value</span>: web3js.utils.toWei(<span class="string">"0.001"</span>,<span class="string">"ether"</span>) &#125;)</span><br><span class="line">         .on(<span class="string">"receipt"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">receipt</span>) </span>&#123;</span><br><span class="line">         $(<span class="string">"#txStatus"</span>).text(<span class="string">"不得了了！僵尸成功升级啦！"</span>);</span><br><span class="line">         &#125;)</span><br><span class="line">         .on(<span class="string">"error"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">error</span>)</span>&#123;</span><br><span class="line">           $(<span class="string">"#txStatus"</span>).text(error);</span><br><span class="line">         &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">getZombieDetails</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cryptoZombies.methods.zombies(id).call()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">zombieToOwner</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cryptoZombies.methods.zombieToOwner(id).call()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">getZombiesByOwner</span>(<span class="params">owner</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cryptoZombies.methods.getZombiesByOwner(owner).call()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">window</span>.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Checking if Web3 has been injected by the browser (Mist/MetaMask)</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> web3 !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">          <span class="comment">// Use Mist/MetaMask's provider</span></span><br><span class="line">          web3js = <span class="keyword">new</span> Web3(web3.currentProvider);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// Handle the case where the user doesn't have Metamask installed</span></span><br><span class="line">          <span class="comment">// Probably show them a message prompting them to install Metamask</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now you can start your app &amp; access web3 freely:</span></span><br><span class="line">        startApp()</span><br><span class="line"></span><br><span class="line">      &#125;)</span><br><span class="line">    &lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>body&gt;</span><br><span class="line">&lt;<span class="regexp">/html&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="订阅事件"><a href="#订阅事件" class="headerlink" title="订阅事件"></a>订阅事件</h1><p>如你所见，通过 Web3.js 和合约交互非常简单直接——一旦你的环境建立起来， <code>call</code> 函数和 <code>send</code> 事务和普通的网络API并没有多少不同。</p>
<p>还有一点东西我们想要讲到——订阅合约事件</p>
<h2 id="监听新僵尸事件"><a href="#监听新僵尸事件" class="headerlink" title="监听新僵尸事件"></a>监听新僵尸事件</h2><p>如果你还记得 <code>zombiefactory.sol</code>，每次新建一个僵尸后，我们会触发一个 <code>NewZombie</code> 事件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">event NewZombie(uint zombieId, string name, uint dna);</span><br></pre></td></tr></table></figure>

<p>在 Web3.js里， 你可以 <strong>订阅</strong> 一个事件，这样你的 Web3 提供者可以在每次事件发生后触发你的一些代码逻辑：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cryptoZombies.events.NewZombie()</span><br><span class="line">.on(&quot;data&quot;, function(event) &#123;</span><br><span class="line">  let zombie = event.returnValues;</span><br><span class="line">  console.log(&quot;一个新僵尸诞生了！&quot;, zombie.zombieId, zombie.name, zombie.dna);</span><br><span class="line">&#125;).on(&apos;error&apos;, console.error);</span><br></pre></td></tr></table></figure>

<p>注意这段代码将在 <strong>任何</strong> 僵尸生成的时候激发一个警告信息——而不仅仅是当前用用户的僵尸。如果我们只想对当前用户发出提醒呢？</p>
<h2 id="使用-indexed"><a href="#使用-indexed" class="headerlink" title="使用 indexed"></a>使用 <code>indexed</code></h2><p>为了筛选仅和当前用户相关的事件，我们的 Solidity 合约将必须使用 <code>indexed</code> 关键字，就像我们在 ERC721 实现中的<code>Transfer</code> 事件中那样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">event Transfer(address indexed _from, address indexed _to, uint256 _tokenId);</span><br></pre></td></tr></table></figure>

<p>在这种情况下， 因为<code>_from</code> 和 <code>_to</code> 都是 <code>indexed</code>，这就意味着我们可以在前端事件监听中过滤事件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cryptoZombies.events.Transfer(&#123; filter: &#123; _to: userAccount &#125; &#125;)</span><br><span class="line">.on(&quot;data&quot;, function(event) &#123;</span><br><span class="line">  let data = event.returnValues;</span><br><span class="line">  // 当前用户更新了一个僵尸！更新界面来显示</span><br><span class="line">&#125;).on(&apos;error&apos;, console.error);</span><br></pre></td></tr></table></figure>

<p>看到了吧， 使用 <code>event</code> 和 <code>indexed</code> 字段对于监听合约中的更改并将其反映到 DApp 的前端界面中是非常有用的做法。</p>
<h2 id="查询过去的事件"><a href="#查询过去的事件" class="headerlink" title="查询过去的事件"></a>查询过去的事件</h2><p>我们甚至可以用 <code>getPastEvents</code> 查询过去的事件，并用过滤器 <code>fromBlock</code> 和 <code>toBlock</code> 给 Solidity 一个事件日志的时间范围(“block” 在这里代表以太坊区块编号）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cryptoZombies.getPastEvents(&quot;NewZombie&quot;, &#123; fromBlock: 0, toBlock: &apos;latest&apos; &#125;)</span><br><span class="line">.then(function(events) &#123;</span><br><span class="line">  // events 是可以用来遍历的 `event` 对象 </span><br><span class="line">  // 这段代码将返回给我们从开始以来创建的僵尸列表</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>因为你可以用这个方法来查询从最开始起的事件日志，这就有了一个非常有趣的用例： <strong>用事件来作为一种更便宜的存储</strong>。</p>
<p>若你还能记得，在区块链上保存数据是 Solidity 中最贵的操作之一。但是用事件就便宜太多太多了。</p>
<p>这里的短板是，事件不能从智能合约本身读取。但是，如果你有一些数据需要永久性地记录在区块链中以便可以在应用的前端中读取，这将是一个很好的用例。这些数据不会影响智能合约向前的状态。</p>
<p>举个栗子，我们可以用事件来作为僵尸战斗的历史纪录——我们可以在每次僵尸攻击别人以及有一方胜出的时候产生一个事件。智能合约不需要这些数据来计算任何接下来的事情，但是这对我们在前端向用户展示来说是非常有用的东西。</p>
<h2 id="Web3-js-事件-和-MetaMask"><a href="#Web3-js-事件-和-MetaMask" class="headerlink" title="Web3.js 事件 和 MetaMask"></a>Web3.js 事件 和 MetaMask</h2><p>上面的示例代码是针对 Web3.js 最新版1.0的，此版本使用了 <strong><em>WebSockets\</em></strong> 来订阅事件。</p>
<p>但是，MetaMask 尚且不支持最新的事件 API (尽管如此，他们已经在实现这部分功能了， <a href="https://github.com/MetaMask/metamask-extension/issues/3642" target="_blank" rel="noopener">点击这里</a> 查看进度)</p>
<p>所以现在我们必须使用一个单独 Web3 提供者，它针对事件提供了WebSockets支持。 我们可以用 Infura 来像实例化第二份拷贝：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var web3Infura = new Web3(new Web3.providers.WebsocketProvider(&quot;wss://mainnet.infura.io/ws&quot;));</span><br><span class="line">var czEvents = new web3Infura.eth.Contract(cryptoZombiesABI, cryptoZombiesAddress);</span><br></pre></td></tr></table></figure>

<p>然后我们将使用 <code>czEvents.events.Transfer</code> 来监听事件，而不再使用 <code>cryptoZombies.events.Transfer</code>。我们将继续在课程的其他部分使用 <code>cryptoZombies.methods</code>。</p>
<p>将来，在 MetaMask 升级了 API 支持 Web3.js 后，我们就不用这么做了。但是现在我们还是要这么做，以使用 Web3.js 更好的最新语法来监听事件。</p>
<h2 id="放在一起"><a href="#放在一起" class="headerlink" title="放在一起"></a>放在一起</h2><p>来添加一些代码监听 <code>Transfer</code> 事件，并在当前用户获得一个新僵尸的时候为他更新界面。</p>
<p>我们将需要在 <code>startApp</code> 底部添加代码，以保证在添加事件监听器之前 <code>cryptoZombies</code> 已经初始化了。</p>
<ol>
<li>在 <code>startApp()</code>底部，为 <code>cryptoZombies.events.Transfer</code> 复制粘贴上面的2行事件监听代码块</li>
<li>复制监听 <code>Transfer</code> 事件的代码块，并用 <code>_to: userAccount</code> 过滤。要记得把 <code>cryptoZombies</code> 换成 <code>czEvents</code> 好在这 里使用 Infura 而不是 MetaMask 来作为提供者。</li>
<li>用 <code>getZombiesByOwner(userAccount).then(displayZombies);</code> 来更新界面</li>
</ol>
<h2 id="页面修改-7"><a href="#页面修改-7" class="headerlink" title="页面修改"></a>页面修改</h2><p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>CryptoZombies front-end<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"web3.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"cryptozombies_abi.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"txStatus"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"zombies"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> cryptoZombies;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> userAccount;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">startApp</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> cryptoZombiesAddress = <span class="string">"YOUR_CONTRACT_ADDRESS"</span>;</span></span><br><span class="line"><span class="actionscript">        cryptoZombies = <span class="keyword">new</span> web3js.eth.Contract(cryptoZombiesABI, cryptoZombiesAddress);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> accountInterval = setInterval(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Check if account has changed</span></span></span><br><span class="line"><span class="actionscript">          <span class="keyword">if</span> (web3.eth.accounts[<span class="number">0</span>] !== userAccount) &#123;</span></span><br><span class="line">            userAccount = web3.eth.accounts[0];</span><br><span class="line"><span class="actionscript">            <span class="comment">// Call a function to update the UI with the new account</span></span></span><br><span class="line">            getZombiesByOwner(userAccount)</span><br><span class="line"><span class="vbscript">            .<span class="keyword">then</span>(displayZombies);</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, 100);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// Start here</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> web3Infura = <span class="keyword">new</span> Web3(<span class="keyword">new</span> Web3.providers.WebsocketProvider(<span class="string">"wss://mainnet.infura.io/ws"</span>));<span class="string">")</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> czEvents = <span class="keyword">new</span> web3Infura.eth.Contract(cryptoZombiesABI, cryptoZombiesAddress);</span></span><br><span class="line">        </span><br><span class="line"><span class="vbscript">        czEvents.events.Transfer(&#123; <span class="built_in">filter</span>: &#123; _to: userAccount &#125; &#125;)</span></span><br><span class="line"><span class="actionscript">        .on(<span class="string">"data"</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">let</span> data = event.returnValues;</span></span><br><span class="line"><span class="vbscript">          getZombiesByOwner(userAccount).<span class="keyword">then</span>(displayZombies);</span></span><br><span class="line"><span class="javascript">        &#125;).on(<span class="string">'error'</span>, <span class="built_in">console</span>.error);</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">displayZombies</span><span class="params">(ids)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">"#zombies"</span>).empty();</span></span><br><span class="line"><span class="javascript">        <span class="keyword">for</span> (id <span class="keyword">of</span> ids) &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Look up zombie details from our contract. Returns a `zombie` object</span></span></span><br><span class="line">          getZombieDetails(id)</span><br><span class="line"><span class="actionscript">          .then(<span class="function"><span class="keyword">function</span><span class="params">(zombie)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// Using ES6's "template literals" to inject variables into the HTML.</span></span></span><br><span class="line"><span class="actionscript">            <span class="comment">// Append each one to our #zombies div</span></span></span><br><span class="line"><span class="vbscript">            $(<span class="string">"#zombies"</span>).append(`&lt;div <span class="keyword">class</span>=<span class="string">"zombie"</span>&gt;</span></span><br><span class="line"><span class="handlebars"><span class="xml">              <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>Name: $&#123;zombie.name&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>DNA: $&#123;zombie.dna&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>Level: $&#123;zombie.level&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>Wins: $&#123;zombie.winCount&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>Losses: $&#123;zombie.lossCount&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>Ready Time: $&#123;zombie.readyTime&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">              <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span>`);</span></span></span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">createRandomZombie</span><span class="params">(name)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// This is going to take a while, so update the UI to let the user know</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// the transaction has been sent</span></span></span><br><span class="line"><span class="javascript">        $(<span class="string">"#txStatus"</span>).text(<span class="string">"Creating new zombie on the blockchain. This may take a while..."</span>);</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// Send the tx to our contract:</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> cryptoZombies.methods.createRandomZombie(name)</span></span><br><span class="line">        .send(&#123; from: userAccount &#125;)</span><br><span class="line"><span class="actionscript">        .on(<span class="string">"receipt"</span>, <span class="function"><span class="keyword">function</span><span class="params">(receipt)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">          $(<span class="string">"#txStatus"</span>).text(<span class="string">"Successfully created "</span> + name + <span class="string">"!"</span>);</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Transaction was accepted into the blockchain, let's redraw the UI</span></span></span><br><span class="line"><span class="vbscript">          getZombiesByOwner(userAccount).<span class="keyword">then</span>(displayZombies);</span></span><br><span class="line">        &#125;)</span><br><span class="line"><span class="actionscript">        .on(<span class="string">"error"</span>, <span class="function"><span class="keyword">function</span><span class="params">(error)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Do something to alert the user their transaction has failed</span></span></span><br><span class="line"><span class="javascript">          $(<span class="string">"#txStatus"</span>).text(error);</span></span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">feedOnKitty</span><span class="params">(zombieId, kittyId)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">"#txStatus"</span>).text(<span class="string">"Eating a kitty. This may take a while..."</span>);</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> cryptoZombies.methods.feedOnKitty(zombieId, kittyId)</span></span><br><span class="line">        .send(&#123; from: userAccount &#125;)</span><br><span class="line"><span class="actionscript">        .on(<span class="string">"receipt"</span>, <span class="function"><span class="keyword">function</span><span class="params">(receipt)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">          $(<span class="string">"#txStatus"</span>).text(<span class="string">"Ate a kitty and spawned a new Zombie!"</span>);</span></span><br><span class="line"><span class="vbscript">          getZombiesByOwner(userAccount).<span class="keyword">then</span>(displayZombies);</span></span><br><span class="line">        &#125;)</span><br><span class="line"><span class="actionscript">        .on(<span class="string">"error"</span>, <span class="function"><span class="keyword">function</span><span class="params">(error)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">          $(<span class="string">"#txStatus"</span>).text(error);</span></span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">levelUp</span><span class="params">(zombieId)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">"#txStatus"</span>).text(<span class="string">"Leveling up your zombie..."</span>);</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> cryptoZombies.methods.levelUp(zombieId)</span></span><br><span class="line"><span class="actionscript">        .send(&#123; from: userAccount, value: web3.utils.toWei(<span class="string">"0.001"</span>, <span class="string">"ether"</span>) &#125;)</span></span><br><span class="line"><span class="actionscript">        .on(<span class="string">"receipt"</span>, <span class="function"><span class="keyword">function</span><span class="params">(receipt)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">          $(<span class="string">"#txStatus"</span>).text(<span class="string">"Power overwhelming! Zombie successfully leveled up"</span>);</span></span><br><span class="line">        &#125;)</span><br><span class="line"><span class="actionscript">        .on(<span class="string">"error"</span>, <span class="function"><span class="keyword">function</span><span class="params">(error)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">          $(<span class="string">"#txStatus"</span>).text(error);</span></span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">getZombieDetails</span><span class="params">(id)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> cryptoZombies.methods.zombies(id).call()</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">zombieToOwner</span><span class="params">(id)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> cryptoZombies.methods.zombieToOwner(id).call()</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">getZombiesByOwner</span><span class="params">(owner)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> cryptoZombies.methods.getZombiesByOwner(owner).call()</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">      <span class="built_in">window</span>.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// Checking if Web3 has been injected by the browser (Mist/MetaMask)</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">if</span> (<span class="keyword">typeof</span> web3 !== <span class="string">'undefined'</span>) &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Use Mist/MetaMask's provider</span></span></span><br><span class="line"><span class="actionscript">          web3js = <span class="keyword">new</span> Web3(web3.currentProvider);</span></span><br><span class="line"><span class="actionscript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Handle the case where the user doesn't have Metamask installed</span></span></span><br><span class="line"><span class="actionscript">          <span class="comment">// Probably show them a message prompting them to install Metamask</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// Now you can start your app &amp; access web3 freely:</span></span></span><br><span class="line">        startApp()</span><br><span class="line"></span><br><span class="line">      &#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="放在一起-1"><a href="#放在一起-1" class="headerlink" title="放在一起"></a>放在一起</h1><p>恭喜啊少年，你已经成功编写了一个 Web3.js 前端界面来和你的智能合约交互</p>
<h2 id="接下来的步骤"><a href="#接下来的步骤" class="headerlink" title="接下来的步骤"></a>接下来的步骤</h2><p>这节课的内容非常基础。我们想要给你展示和智能合约交互的核心内容，而并不想用太多的时间来教你完整实现。我们也不想花太多时间在HTML/CSS上，因为大部分人都已经知道了。</p>
<p>所以我们把一些实现略去了。这里是你要完整实现所需要完成的基本事项列表：</p>
<ol>
<li><p>为 <code>attack</code>, <code>changeName</code>, <code>changeDna</code> 以及 ERC721 函数 <code>transfer</code>, <code>ownerOf</code>, <code>balanceOf</code> 等实现前端函数。这些函数的实现将和我们讲过的 <code>send</code>事务的函数非常相似。</p>
</li>
<li><p>实现一个“管理界面”，在那里你可以调用 <code>setKittyContractAddress</code>, <code>setLevelUpFee</code>, 以及 <code>withdraw</code>。再次，在前端这块没有什么特别的代码——这些实现之间将非常相似。你应该保证从部署合同时候相同的以太坊地址调用这些函数，因为他们都有<code>onlyOwner</code> 修饰符。</p>
</li>
<li><p>在应用里我们还应该实现一些其他的界面：</p>
<p>a. 一个僵尸页面，在那里你可以查看一个特定僵尸的信息并可以分享它的链接。这个页面应该渲染僵尸的外形，展示它的名字，它的所有者（以及用户主页的链接），它的输赢次数，它的战斗记录等等。</p>
<p>b. 一个用户界面，在那里你可以查看用户的僵尸大军并分享它的链接。</p>
<p>c. 一个主页，就是用户页面的变体，可以展示当前用户的僵尸大军（正如我们在index.html）里面实现的那样。</p>
</li>
<li><p>界面中的一些方法允许用户用 CryptoKitties 喂食僵尸。我们可以给每一个僵尸添加一个按钮，叫做“给我投食”，再给一个输入框让用户输入一个猫咪的ID（或者一个猫咪的网址，比如<a href="https://www.cryptokitties.co/kitty/578397），它将触发我们的" target="_blank" rel="noopener">https://www.cryptokitties.co/kitty/578397），它将触发我们的</a> <code>feedOnKitty</code> 函数。</p>
</li>
<li><p>界面中的一些方法将让用户用来攻击其他用户的僵尸</p>
<p>实现这点的一个方法是，当用户浏览其他用户的页面的时候，可以在对方僵尸旁边显示一个按钮，叫做“攻击这头僵尸”。当用户点击的时候，可以弹出一个模块，展示当前用户的僵尸大军并询问用户“你想用哪头僵尸出战？”</p>
<p>在用户的主页，也可以在每个僵尸旁边显示一个按钮，叫做“攻击一个僵尸”。当用户点击的时候，可以弹出一个模块，展示一个搜索框，可以让用户输入僵尸ID或者网址来搜索，或者也可以有一个按钮叫做“随机攻击一头僵尸”，将随机搜索一头僵尸来。</p>
<p>我们也建议你将在冷却期的僵尸用特殊的颜色显示，比如使其变成灰色。这样界面就能告诉用户不能用冷却期的僵尸来进攻。</p>
</li>
<li><p>在用户的主页，每一个僵尸也应该有选项可以更改名字、DNA、以及升级（通过付费）。若用户等级不到，无法使用的选项应该标灰。</p>
</li>
<li><p>对于新用户，我们应该显示一个欢迎信息，并让其确认用 <code>createRandomZombie()</code>创建一个新僵尸。</p>
</li>
<li><p>也可以为我们的智能合约添加一个包含<code>indexed</code> 的用户地址属性的 <code>Attack</code> 事件。这样就可以创建实时通知了——我们可以在用户的僵尸遭受攻击的时候弹出一条通知，这样他们可以看到谁在用什么僵尸攻击他们并做出报复。</p>
</li>
<li><p>我们也许还想实现一些前端缓存层，这样就不用总是为了相同的数据去访问Infura。（在我们当前实现中，<code>displayZombies</code> 将在每次页面刷新的时候为每一个僵尸调用 <code>getZombieDetails</code>，但是实际中我们将只需要为新加入的僵尸调用这个函数）</p>
</li>
<li><p>一个实时聊天室，这样你就可以在你击溃别人的僵尸大军的同时嘲讽他们？</p>
</li>
</ol>
<p>因为这将需要大量的前端代码来实现全部的界面（HTML， CSS， JavaScript 以及诸如 React 和 Vue.js 这样的框架）。光实现一个这样的前端界面也许会花费多达10节课，所以我们将这个光荣的任务交给你自己去完成。</p>
<blockquote>
<p>注意：尽管智能合约是去中心化的。这个用来和DApp交互的前端界面依然需要放在我们中心化的网络服务器上。不过，有了我们正在内测的<a href="https://medium.com/loom-network-chinese/3d0d686163df" target="_blank" rel="noopener">Loom Network</a> SDK，很快你就可以在应用自己的DApp链上运行前端界面而不是中心化的网络服务器。这样在以太坊和 Loom DApp 链上，你的整个应用都100%运行在区块链上了。</p>
</blockquote>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>学完第六课。你现在有了编写智能合约和前端界面来让用户交互的所需技能了。</p>
<p>在下一课。 我们将涉及这个历程中最后缺失的一部分——将你的智能合约部署到以太坊。</p>
<p>知道你已经急不可耐了，点击“下一章”领取你的奖励吧。</p>
<p><img src="https://i.loli.net/2020/06/30/HMZXOmk7bAvPoIS.png" alt="image-20200630142837304"></p>
<h1 id="第六课打卡"><a href="#第六课打卡" class="headerlink" title="第六课打卡"></a>第六课打卡</h1><p><img src="https://i.loli.net/2020/06/30/k35KTEDdXcHyVzM.png" alt="image-20200630143006394"></p>
<p><a href="https://share.cryptozombies.io/zh/lesson/6/share/The_Phantom_of_Web3" target="_blank" rel="noopener">我的僵尸大军6</a></p>

    </div>

    
    
    
      
        <div class="reward-container">
  <div>您的支持是我继续创作的动力</div>
  <button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="李松柏 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="李松柏 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>李松柏
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://lisongbai.top/2020/06/30/web3-js/" title="web3.js">http://lisongbai.top/2020/06/30/web3-js/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/null" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/web3-js/" rel="tag"># web3.js</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/2020/06/29/ERC721%E6%A0%87%E5%87%86%E5%92%8C%E5%8A%A0%E5%AF%86%E6%94%B6%E8%97%8F%E5%93%81/" rel="next" title="ERC721标准和加密收藏品">
                  <i class="fa fa-chevron-left"></i> ERC721标准和加密收藏品
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/2020/06/30/%E4%BD%BF%E7%94%A8truffle%E6%B5%8B%E8%AF%95%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/" rel="prev" title="使用truffle测试智能合约">
                  使用truffle测试智能合约 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-disqus">disqus</a></li>
            <li class="tab"><a href="#comment-livere">livere</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane disqus" id="comment-disqus">
              
  <div class="comments" id="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  
            </div>
            <div class="tab-pane livere" id="comment-livere">
              
  <div class="comments" id="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC80NzY2MC8yNDE1OA=="></div>
  </div>
  
            </div>
        </div>
      </div>
      <script>
        window.addEventListener('tabs:register', () => {
          let activeClass = '';
            activeClass = localStorage.getItem('comments_active') || activeClass;
          if (activeClass) {
            let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
            if (activeTab) {
              activeTab.click();
            }
          }
        });
        window.addEventListener('tabs:click', event => {
          let commentClass = event.target.classList[1];
          localStorage.setItem('comments_active', commentClass);
        });
      </script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#介绍-Web3-js"><span class="nav-number">1.</span> <span class="nav-text">介绍 Web3.js</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是-Web3-js"><span class="nav-number">1.1.</span> <span class="nav-text">什么是 Web3.js?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备好了么？"><span class="nav-number">1.2.</span> <span class="nav-text">准备好了么？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习"><span class="nav-number">1.3.</span> <span class="nav-text">实战演习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#页面创建"><span class="nav-number">1.4.</span> <span class="nav-text">页面创建</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Web3-提供者"><span class="nav-number">2.</span> <span class="nav-text">Web3 提供者</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Infura"><span class="nav-number">2.1.</span> <span class="nav-text">Infura</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Metamask"><span class="nav-number">2.2.</span> <span class="nav-text">Metamask</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用-Metamask-的-web3-提供者"><span class="nav-number">2.3.</span> <span class="nav-text">使用 Metamask 的 web3 提供者</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习-1"><span class="nav-number">2.4.</span> <span class="nav-text">实战演习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#页面修改"><span class="nav-number">2.5.</span> <span class="nav-text">页面修改</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#和合约对话"><span class="nav-number">3.</span> <span class="nav-text">和合约对话</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#合约地址"><span class="nav-number">3.1.</span> <span class="nav-text">合约地址</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#合约-ABI"><span class="nav-number">3.2.</span> <span class="nav-text">合约 ABI</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实例化-Web3-js"><span class="nav-number">3.3.</span> <span class="nav-text">实例化 Web3.js</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习-2"><span class="nav-number">3.4.</span> <span class="nav-text">实战演习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#页面修改-1"><span class="nav-number">3.5.</span> <span class="nav-text">页面修改</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#调用和合约函数"><span class="nav-number">4.</span> <span class="nav-text">调用和合约函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Call"><span class="nav-number">4.0.1.</span> <span class="nav-text">Call</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Send"><span class="nav-number">4.0.2.</span> <span class="nav-text">Send</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#获取僵尸数据"><span class="nav-number">4.1.</span> <span class="nav-text">获取僵尸数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习-3"><span class="nav-number">4.2.</span> <span class="nav-text">实战演习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#页面修改-2"><span class="nav-number">4.3.</span> <span class="nav-text">页面修改</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MetaMask-和账户"><span class="nav-number">5.</span> <span class="nav-text">MetaMask 和账户</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#获得-MetaMask中的用户账户"><span class="nav-number">5.1.</span> <span class="nav-text">获得 MetaMask中的用户账户</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习-4"><span class="nav-number">5.2.</span> <span class="nav-text">实战演习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#页面修改-3"><span class="nav-number">5.3.</span> <span class="nav-text">页面修改</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#显示僵尸大军"><span class="nav-number">6.</span> <span class="nav-text">显示僵尸大军</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#显示僵尸数据-—-一个粗略的例子"><span class="nav-number">6.1.</span> <span class="nav-text">显示僵尸数据 — 一个粗略的例子</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何来展示僵尸元素呢？"><span class="nav-number">6.2.</span> <span class="nav-text">如何来展示僵尸元素呢？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习-5"><span class="nav-number">6.3.</span> <span class="nav-text">实战演习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#页面修改-4"><span class="nav-number">6.4.</span> <span class="nav-text">页面修改</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#发送事务"><span class="nav-number">7.</span> <span class="nav-text">发送事务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#生成一个僵尸"><span class="nav-number">7.1.</span> <span class="nav-text">生成一个僵尸</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习-6"><span class="nav-number">7.2.</span> <span class="nav-text">实战演习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#页面修改-5"><span class="nav-number">7.3.</span> <span class="nav-text">页面修改</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#调用-Payable-函数"><span class="nav-number">8.</span> <span class="nav-text">调用 Payable 函数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#升级！"><span class="nav-number">8.1.</span> <span class="nav-text">升级！</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#啥是-Wei"><span class="nav-number">8.2.</span> <span class="nav-text">啥是 Wei?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习-7"><span class="nav-number">8.3.</span> <span class="nav-text">实战演习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#页面修改-6"><span class="nav-number">8.4.</span> <span class="nav-text">页面修改</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#订阅事件"><span class="nav-number">9.</span> <span class="nav-text">订阅事件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#监听新僵尸事件"><span class="nav-number">9.1.</span> <span class="nav-text">监听新僵尸事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用-indexed"><span class="nav-number">9.2.</span> <span class="nav-text">使用 indexed</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询过去的事件"><span class="nav-number">9.3.</span> <span class="nav-text">查询过去的事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Web3-js-事件-和-MetaMask"><span class="nav-number">9.4.</span> <span class="nav-text">Web3.js 事件 和 MetaMask</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#放在一起"><span class="nav-number">9.5.</span> <span class="nav-text">放在一起</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#页面修改-7"><span class="nav-number">9.6.</span> <span class="nav-text">页面修改</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#放在一起-1"><span class="nav-number">10.</span> <span class="nav-text">放在一起</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#接下来的步骤"><span class="nav-number">10.1.</span> <span class="nav-text">接下来的步骤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">10.2.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第六课打卡"><span class="nav-number">11.</span> <span class="nav-text">第六课打卡</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="李松柏"
    src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">李松柏</p>
  <div class="site-description" itemprop="description">记录学习的技能和遇到的问题</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">66</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/yym08090809" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;yym08090809" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:songbai0112@163.com" title="E-Mail &amp;rarr; mailto:songbai0112@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/null" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李松柏</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.4.2
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>






  <script>
  function leancloudSelector(url) {
    return document.getElementById(url).querySelector('.leancloud-visitors-count');
  }
  if (CONFIG.page.isPost) {
    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = visitors.getAttribute('id').trim();
      var title = visitors.getAttribute('data-flag-title').trim();

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .then(response => response.json())
              .then(() => {
                leancloudSelector(url).innerText = counter.time + 1;
              })
              .catch(error => {
                console.log('Failed to save visitor count', error);
              })
          } else {
              leancloudSelector(url).innerText = 'Counter not initialized! More info at console err msg.';
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .catch(error => {
          console.log('LeanCloud Counter Error', error);
        });
    }
  } else {
    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return element.getAttribute('id').trim();
      });

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url: { '$in': entries } })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length === 0) {
            document.querySelectorAll('.leancloud_visitors .leancloud-visitors-count').forEach(element => {
              element.innerText = 0;
            });
            return;
          }
          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.url;
            var time = item.time;
            leancloudSelector(url).innerText = time;
          }
          for (var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = leancloudSelector(url);
            if (element.innerText == '') {
              element.innerText = 0;
            }
          }
        })
        .catch(error => {
          console.log('LeanCloud Counter Error', error);
        });
    }
  }

  fetch('https://app-router.leancloud.cn/2/route?appId=')
    .then(response => response.json())
    .then(({ api_server }) => {
      var Counter = (method, url, data) => {
        return fetch(`https://${api_server}/1.1${url}`, {
          method: method,
          headers: {
            'X-LC-Id': '',
            'X-LC-Key': '',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        const localhost = /http:\/\/(localhost|127.0.0.1|0.0.0.0)/;
        if (localhost.test(document.URL)) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    });
  </script>






        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://visitor.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  function loadComments() {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "http://lisongbai.top/2020/06/30/web3-js/",
            identifier: "2020/06/30/web3-js/",
            title: "web3.js"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://visitor.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  }
    window.addEventListener('load', loadComments, false);
</script>

<script>
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
</script>

 
</body>
</html>
