<!DOCTYPE html>
<html lang="zh-CN">
<head>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.4.2',
    exturl: false,
    sidebar: {"position":"left","display":"hide","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="以太坊上的代币让我们来聊聊 代币.如果你对以太坊的世界有一些了解，你很可能听过人们聊到代币——尤其是 ERC20 代币\.一个 代币 在以太坊基本上就是一个遵循一些共同规则的智能合约——即它实现了所有其他代币合约共享的一组标准函数，例如 transfer(address _to, uint256 _value) 和 balanceOf(address _owner).">
<meta name="keywords" content="solidity">
<meta property="og:type" content="article">
<meta property="og:title" content="ERC721标准和加密收藏品">
<meta property="og:url" content="http:&#x2F;&#x2F;lisongbai.top&#x2F;2020&#x2F;06&#x2F;29&#x2F;ERC721%E6%A0%87%E5%87%86%E5%92%8C%E5%8A%A0%E5%AF%86%E6%94%B6%E8%97%8F%E5%93%81&#x2F;index.html">
<meta property="og:site_name" content="小李の博客">
<meta property="og:description" content="以太坊上的代币让我们来聊聊 代币.如果你对以太坊的世界有一些了解，你很可能听过人们聊到代币——尤其是 ERC20 代币\.一个 代币 在以太坊基本上就是一个遵循一些共同规则的智能合约——即它实现了所有其他代币合约共享的一组标准函数，例如 transfer(address _to, uint256 _value) 和 balanceOf(address _owner).">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;06&#x2F;29&#x2F;OwCBJ4kfo8W9RpM.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;06&#x2F;29&#x2F;Rt1SieE7unND4zc.png">
<meta property="og:updated_time" content="2020-06-29T15:34:10.047Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;06&#x2F;29&#x2F;OwCBJ4kfo8W9RpM.png">

<link rel="canonical" href="http://lisongbai.top/2020/06/29/ERC721%E6%A0%87%E5%87%86%E5%92%8C%E5%8A%A0%E5%AF%86%E6%94%B6%E8%97%8F%E5%93%81/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>ERC721标准和加密收藏品 | 小李の博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="小李の博客" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小李の博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">我有一壶酒，足以慰平生。</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/yym08090809" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lisongbai.top/2020/06/29/ERC721%E6%A0%87%E5%87%86%E5%92%8C%E5%8A%A0%E5%AF%86%E6%94%B6%E8%97%8F%E5%93%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李松柏">
      <meta itemprop="description" content="记录学习的技能和遇到的问题">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小李の博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ERC721标准和加密收藏品
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-06-29 18:44:50 / 修改时间：23:34:10" itemprop="dateCreated datePublished" datetime="2020-06-29T18:44:50+08:00">2020-06-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/loom-network/" itemprop="url" rel="index">
                    <span itemprop="name">loom network</span>
                  </a>
                </span>
            </span>

          
            <span id="/2020/06/29/ERC721%E6%A0%87%E5%87%86%E5%92%8C%E5%8A%A0%E5%AF%86%E6%94%B6%E8%97%8F%E5%93%81/" class="post-meta-item leancloud_visitors" data-flag-title="ERC721标准和加密收藏品" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2020/06/29/ERC721%E6%A0%87%E5%87%86%E5%92%8C%E5%8A%A0%E5%AF%86%E6%94%B6%E8%97%8F%E5%93%81/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/06/29/ERC721标准和加密收藏品/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="以太坊上的代币"><a href="#以太坊上的代币" class="headerlink" title="以太坊上的代币"></a>以太坊上的代币</h1><p>让我们来聊聊 <strong><em>代币</em></strong>.</p><p>如果你对以太坊的世界有一些了解，你很可能听过人们聊到代币——尤其是 <strong><em>ERC20 代币\</em></strong>.</p><p>一个 <strong><em>代币</em></strong> 在以太坊基本上就是一个遵循一些共同规则的智能合约——即它实现了所有其他代币合约共享的一组标准函数，例如 <code>transfer(address _to, uint256 _value)</code> 和 <code>balanceOf(address _owner)</code>.</p><a id="more"></a>


<p>在智能合约内部，通常有一个映射， <code>mapping(address =&gt; uint256) balances</code>，用于追踪每个地址还有多少余额。</p>
<p>所以基本上一个代币只是一个追踪谁拥有多少该代币的合约，和一些可以让那些用户将他们的代币转移到其他地址的函数。</p>
<h2 id="它为什么重要呢？"><a href="#它为什么重要呢？" class="headerlink" title="它为什么重要呢？"></a>它为什么重要呢？</h2><p>由于所有 ERC20 代币共享具有相同名称的同一组函数，它们都可以以相同的方式进行交互。</p>
<p>这意味着如果你构建的应用程序能够与一个 ERC20 代币进行交互，那么它就也能够与任何 ERC20 代币进行交互。 这样一来，将来你就可以轻松地将更多的代币添加到你的应用中，而无需进行自定义编码。 你可以简单地插入新的代币合约地址，然后哗啦，你的应用程序有另一个它可以使用的代币了。</p>
<p>其中一个例子就是交易所。 当交易所添加一个新的 ERC20 代币时，实际上它只需要添加与之对话的另一个智能合约。 用户可以让那个合约将代币发送到交易所的钱包地址，然后交易所可以让合约在用户要求取款时将代币发送回给他们。</p>
<p>交易所只需要实现这种转移逻辑一次，然后当它想要添加一个新的 ERC20 代币时，只需将新的合约地址添加到它的数据库即可。</p>
<h2 id="其他代币标准"><a href="#其他代币标准" class="headerlink" title="其他代币标准"></a>其他代币标准</h2><p>对于像货币一样的代币来说，ERC20 代币非常酷。 但是要在我们僵尸游戏中代表僵尸就并不是特别有用。</p>
<p>首先，僵尸不像货币可以分割 —— 我可以发给你 0.237 以太，但是转移给你 0.237 的僵尸听起来就有些搞笑。</p>
<p>其次，并不是所有僵尸都是平等的。 你的2级僵尸”<strong>Steve</strong>“完全不能等同于我732级的僵尸”<strong>H4XF13LD MORRIS 💯💯😎💯💯</strong>“。（你差得远呢，<em>Steve</em>）。</p>
<p>有另一个代币标准更适合如 CryptoZombies 这样的加密收藏品——它们被称为<strong><em>ERC721 代币.\</em></strong></p>
<p><strong><em>ERC721 代币\</em></strong>是<strong>不</strong>能互换的，因为每个代币都被认为是唯一且不可分割的。 你只能以整个单位交易它们，并且每个单位都有唯一的 ID。 这些特性正好让我们的僵尸可以用来交易。</p>
<blockquote>
<p>请注意，使用像 ERC721 这样的标准的优势就是，我们不必在我们的合约中实现拍卖或托管逻辑，这决定了玩家能够如何交易／出售我们的僵尸。 如果我们符合规范，其他人可以为加密可交易的 ERC721 资产搭建一个交易所平台，我们的 ERC721 僵尸将可以在该平台上使用。 所以使用代币标准相较于使用你自己的交易逻辑有明显的好处。</p>
</blockquote>
<h2 id="实战演习"><a href="#实战演习" class="headerlink" title="实战演习"></a>实战演习</h2><p>我们将在下一章深入讨论ERC721的实现。 但首先，让我们为本课设置我们的文件结构。</p>
<p>我们将把所有ERC721逻辑存储在一个叫<code>ZombieOwnership</code>的合约中。</p>
<ol>
<li>在文件顶部声明我们<code>pragma</code>的版本（格式参考之前的课程）。</li>
<li>将 <code>zombieattack.sol</code> <code>import</code> 进来。</li>
<li>声明一个继承 <code>ZombieAttack</code> 的新合约， 命名为<code>ZombieOwnership</code>。合约的其他部分先留空。</li>
</ol>
<h2 id="合约创建"><a href="#合约创建" class="headerlink" title="合约创建"></a>合约创建</h2><p>ZombieOwnership.sol</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./zombieattack.sol"</span>;</span><br><span class="line">contract ZombieOwnership is ZombieAttack &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ERC721-标准-多重继承"><a href="#ERC721-标准-多重继承" class="headerlink" title="ERC721 标准, 多重继承"></a>ERC721 标准, 多重继承</h1><p>让我们来看一看 ERC721 标准：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">contract ERC721 &#123;</span><br><span class="line">  event Transfer(address indexed _from, address indexed _to, uint256 _tokenId);</span><br><span class="line">  event Approval(address indexed _owner, address indexed _approved, uint256 _tokenId);</span><br><span class="line"></span><br><span class="line">  function balanceOf(address _owner) public view returns (uint256 _balance);</span><br><span class="line">  function ownerOf(uint256 _tokenId) public view returns (address _owner);</span><br><span class="line">  function transfer(address _to, uint256 _tokenId) public;</span><br><span class="line">  function approve(address _to, uint256 _tokenId) public;</span><br><span class="line">  function takeOwnership(uint256 _tokenId) public;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是我们需要实现的方法列表，我们将在接下来的章节中逐个学习。</p>
<p>虽然看起来很多，但不要被吓到了！我们在这里就是准备带着你一步一步了解它们的。</p>
<blockquote>
<p>注意： ERC721目前是一个 <em>草稿</em>，还没有正式商定的实现。在本教程中，我们使用的是 OpenZeppelin 库中的当前版本，但在未来正式发布之前它可能会有更改。 所以把这 <strong>一个</strong> 可能的实现当作考虑，但不要把它作为 ERC721 代币的官方标准。</p>
</blockquote>
<h2 id="实现一个代币合约"><a href="#实现一个代币合约" class="headerlink" title="实现一个代币合约"></a>实现一个代币合约</h2><p>在实现一个代币合约的时候，我们首先要做的是将接口复制到它自己的 Solidity 文件并导入它，<code>import &quot;./erc721.sol&quot;;</code>。 接着，让我们的合约继承它，然后我们用一个函数定义来重写每个方法。</p>
<p>但等一下—— <code>ZombieOwnership</code>已经继承自 <code>ZombieAttack</code>了 —— 它如何能够也继承于 <code>ERC721</code>呢？</p>
<p>幸运的是在Solidity，你的合约可以继承自多个合约，参考如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">contract SatoshiNakamoto is NickSzabo, HalFinney &#123;</span><br><span class="line">  // 啧啧啧，宇宙的奥秘泄露了</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正如你所见，当使用多重继承的时候，你只需要用逗号 <code>,</code> 来隔开几个你想要继承的合约。在上面的例子中，我们的合约继承自 <code>NickSzabo</code> 和 <code>HalFinney</code>。</p>
<p>来试试吧。</p>
<h2 id="实战演习-1"><a href="#实战演习-1" class="headerlink" title="实战演习"></a>实战演习</h2><p>我们已经在上面为你创建了带着接口的 <code>erc721.sol</code> 。</p>
<ol>
<li>将 <code>erc721.sol</code> 导入到 <code>zombieownership.sol</code></li>
<li>声明 <code>ZombieOwnership</code> 继承自 <code>ZombieAttack</code> 和 <code>ERC721</code></li>
</ol>
<h2 id="合约完善"><a href="#合约完善" class="headerlink" title="合约完善"></a>合约完善</h2><p>ZombieOwnership.sol</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"./zombieattack.sol"</span>;</span><br><span class="line"><span class="comment">// 在这里引入文件</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"./erc721.sol"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在这里声明 ERC721 的继承</span></span><br><span class="line">contract ZombieOwnership is ZombieAttack, ERC721 &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="balanceOf-和-ownerOf"><a href="#balanceOf-和-ownerOf" class="headerlink" title="balanceOf 和 ownerOf"></a>balanceOf 和 ownerOf</h1><p>太棒了，我们来深入讨论一下 ERC721 的实现。</p>
<p>我们已经把所有你需要在本课中实现的函数的空壳复制好了。</p>
<p>在本章节，我们将实现头两个方法： <code>balanceOf</code> 和 <code>ownerOf</code>。</p>
<h2 id="balanceOf"><a href="#balanceOf" class="headerlink" title="balanceOf"></a><code>balanceOf</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">function balanceOf(address _owner) public view returns (uint256 _balance);</span><br></pre></td></tr></table></figure>

<p>这个函数只需要一个传入 <code>address</code> 参数，然后返回这个 <code>address</code> 拥有多少代币。</p>
<p>在我们的例子中，我们的“代币”是僵尸。你还记得在我们 DApp 的哪里存储了一个主人拥有多少只僵尸吗？</p>
<h2 id="ownerOf"><a href="#ownerOf" class="headerlink" title="ownerOf"></a><code>ownerOf</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">function ownerOf(uint256 _tokenId) public view returns (address _owner);</span><br></pre></td></tr></table></figure>

<p>这个函数需要传入一个代币 ID 作为参数 (我们的情况就是一个僵尸 ID)，然后返回该代币拥有者的 <code>address</code>。</p>
<p>同样的，因为在我们的 DApp 里已经有一个 <code>mapping</code> (映射) 存储了这个信息，所以对我们来说这个实现非常直接清晰。我们可以只用一行 <code>return</code> 语句来实现这个函数。</p>
<blockquote>
<p>注意：要记得， <code>uint256</code> 等同于<code>uint</code>。我们从课程的开始一直在代码中使用 <code>uint</code>，但从现在开始我们将在这里用 <code>uint256</code>，因为我们直接从规范中复制粘贴。</p>
</blockquote>
<h2 id="实战演习-2"><a href="#实战演习-2" class="headerlink" title="实战演习"></a>实战演习</h2><p>我将让你来决定如何实现这两个函数。</p>
<p>每个函数的代码都应该只有1行 <code>return</code> 语句。看看我们在之前课程中写的代码，想想我们都把这个数据存储在哪。如果你觉得有困难，你可以点“我要看答案”的按钮来获得帮助。</p>
<ol>
<li>实现 <code>balanceOf</code> 来返回 <code>_owner</code> 拥有的僵尸数量。</li>
<li>实现 <code>ownerOf</code> 来返回拥有 ID 为 <code>_tokenId</code> 僵尸的所有者的地址。</li>
</ol>
<h2 id="合约完善-1"><a href="#合约完善-1" class="headerlink" title="合约完善"></a>合约完善</h2><p>ZombieOwnership.sol</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"./zombieattack.sol"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./erc721.sol"</span>;</span><br><span class="line"></span><br><span class="line">contract ZombieOwnership is ZombieAttack, ERC721 &#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _owner</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint256 _balance</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 在这里返回 `_owner` 拥有的僵尸数</span></span><br><span class="line">    <span class="keyword">return</span> ownerZombieCount[_owner];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">ownerOf</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">address _owner</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 2. 在这里返回 `_tokenId` 的所有者</span></span><br><span class="line">    <span class="keyword">return</span> zombieToOwner[_tokenId];</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">approve</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">takeOwnership</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="重构"><a href="#重构" class="headerlink" title="重构"></a>重构</h1><p>嘿嘿！我们刚刚的代码中其实有个错误，以至于其根本无法通过编译，你发现了没？</p>
<p>在前一个章节我们定义了一个叫 <code>ownerOf</code> 的函数。但如果你还记得第4课的内容，我们同样在<code>zombiefeeding.sol</code> 里以 <code>ownerOf</code> 命名创建了一个 <code>modifier</code>（修饰符）。</p>
<p>如果你尝试编译这段代码，编译器会给你一个错误说你不能有相同名称的修饰符和函数。</p>
<p>所以我们应该把在 <code>ZombieOwnership</code> 里的函数名称改成别的吗？</p>
<p>不，我们不能那样做！！！要记得，我们正在用 ERC721 代币标准，意味着其他合约将期望我们的合约以这些确切的名称来定义函数。这就是这些标准实用的原因——如果另一个合约知道我们的合约符合 ERC721 标准，它可以直接与我们交互，而无需了解任何关于我们内部如何实现的细节。</p>
<p>所以，那意味着我们将必须重构我们第4课中的代码，将 <code>modifier</code> 的名称换成别的。</p>
<h2 id="实战演习-3"><a href="#实战演习-3" class="headerlink" title="实战演习"></a>实战演习</h2><p>我们回到了 <code>zombiefeeding.sol</code> 。我们将把 <code>modifier</code> 的名称从 <code>ownerOf</code> 改成 <code>onlyOwnerOf</code>。</p>
<ol>
<li>把修饰符定义中的名称改成 <code>onlyOwnerOf</code></li>
<li>往下滑到使用此修饰符的函数 <code>feedAndMultiply</code> 。我们也需要改这里的名称。</li>
</ol>
<blockquote>
<p>注意：我们在 <code>zombiehelper.sol</code> 和 <code>zombieattack.sol</code> 里也使用了这个修饰符，但为了不在这节课的重构里花太多时间，我们已经将那些文件里的修饰符名称为你改好了。</p>
</blockquote>
<h2 id="合约修改"><a href="#合约修改" class="headerlink" title="合约修改"></a>合约修改</h2><p>zombiefeeding.sol</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"./zombiefactory.sol"</span>;</span><br><span class="line"></span><br><span class="line">contract KittyInterface &#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getKitty</span>(<span class="params">uint256 _id</span>) <span class="title">external</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    bool isGestating,</span></span></span><br><span class="line"><span class="function"><span class="params">    bool isReady,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 cooldownIndex,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 nextActionAt,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 siringWithId,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 birthTime,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 matronId,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 sireId,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 generation,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 genes</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">ZombieFeeding</span> <span class="title">is</span> <span class="title">ZombieFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  KittyInterface kittyContract;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1. 把修饰符名称改成 `onlyOwnerOf`</span></span><br><span class="line">  <span class="comment">//modifier ownerOf(uint _zombieId) &#123;</span></span><br><span class="line">    modifier onlyOwnerOf(uint _zombieId) &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.sender == zombieToOwner[_zombieId]);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setKittyContractAddress</span>(<span class="params">address _address</span>) <span class="title">external</span> <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">    kittyContract = KittyInterface(_address);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_triggerCooldown</span>(<span class="params">Zombie storage _zombie</span>) <span class="title">internal</span> </span>&#123;</span><br><span class="line">    _zombie.readyTime = uint32(now + cooldownTime);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_isReady</span>(<span class="params">Zombie storage _zombie</span>) <span class="title">internal</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> (_zombie.readyTime &lt;= now);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. 这里也要修改修饰符的名称</span></span><br><span class="line">  <span class="comment">//function feedAndMultiply(uint _zombieId, uint _targetDna, string _species) internal ownerOf(_zombieId) &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">feedAndMultiply</span>(<span class="params">uint _zombieId, uint _targetDna, string _species</span>) <span class="title">internal</span>  <span class="title">onlyOwnerOf</span>(<span class="params">_zombieId</span>) </span>&#123;</span><br><span class="line">    Zombie storage myZombie = zombies[_zombieId];</span><br><span class="line">    <span class="built_in">require</span>(_isReady(myZombie));</span><br><span class="line">    _targetDna = _targetDna % dnaModulus;</span><br><span class="line">    uint newDna = (myZombie.dna + _targetDna) / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (keccak256(_species) == keccak256(<span class="string">"kitty"</span>)) &#123;</span><br><span class="line">      newDna = newDna - newDna % <span class="number">100</span> + <span class="number">99</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _createZombie(<span class="string">"NoName"</span>, newDna);</span><br><span class="line">    _triggerCooldown(myZombie);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">feedOnKitty</span>(<span class="params">uint _zombieId, uint _kittyId</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    uint kittyDna;</span><br><span class="line">    (,,,,,,,,,kittyDna) = kittyContract.getKitty(_kittyId);</span><br><span class="line">    feedAndMultiply(_zombieId, kittyDna, <span class="string">"kitty"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ERC721-转移标准"><a href="#ERC721-转移标准" class="headerlink" title="ERC721: 转移标准"></a>ERC721: 转移标准</h1><p>好了，我们将冲突修复了！</p>
<p>现在我们将通过学习把所有权从一个人转移给另一个人来继续我们的 ERC721 规范的实现。</p>
<p>注意 ERC721 规范有两种不同的方法来转移代币：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">function</span> <span class="title">approve</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span>;</span></span><br><span class="line"><span class="function"><span class="title">function</span> <span class="title">takeOwnership</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span>;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>第一种方法是代币的拥有者调用<code>transfer</code> 方法，传入他想转移到的 <code>address</code> 和他想转移的代币的 <code>_tokenId</code>。</li>
<li>第二种方法是代币拥有者首先调用 <code>approve</code>，然后传入与以上相同的参数。接着，该合约会存储谁被允许提取代币，通常存储到一个 <code>mapping (uint256 =&gt; address)</code> 里。然后，当有人调用 <code>takeOwnership</code> 时，合约会检查 <code>msg.sender</code> 是否得到拥有者的批准来提取代币，如果是，则将代币转移给他。</li>
</ol>
<p>你注意到了吗，<code>transfer</code> 和 <code>takeOwnership</code> 都将包含相同的转移逻辑，只是以相反的顺序。 （一种情况是代币的发送者调用函数；另一种情况是代币的接收者调用它）。</p>
<p>所以我们把这个逻辑抽象成它自己的私有函数 <code>_transfer</code>，然后由这两个函数来调用它。 这样我们就不用写重复的代码了。</p>
<h2 id="实战演习-4"><a href="#实战演习-4" class="headerlink" title="实战演习"></a>实战演习</h2><p>让我们来定义 <code>_transfer</code> 的逻辑。</p>
<ol>
<li><p>定义一个名为 <code>_transfer</code>的函数。它会需要3个参数：<code>address _from</code>、<code>address _to</code>和<code>uint256 _tokenId</code>。它应该是一个 <code>私有</code> 函数。</p>
</li>
<li><p>我们有2个映射会在所有权改变的时候改变： <code>ownerZombieCount</code> （记录一个所有者有多少只僵尸）和 <code>zombieToOwner</code> （记录什么人拥有什么）。</p>
<p>我们的函数需要做的第一件事是为 <strong>接收</strong> 僵尸的人（<code>address _to</code>）增 加<code>ownerZombieCount</code>。使用 <code>++</code> 来增加。</p>
</li>
<li><p>接下来，我们将需要为 <strong>发送</strong> 僵尸的人（<code>address _from</code>）<strong>减少</strong><code>ownerZombieCount</code>。使用 <code>--</code> 来扣减。</p>
</li>
<li><p>最后，我们将改变这个 <code>_tokenId</code> 的 <code>zombieToOwner</code> 映射，这样它现在就会指向 <code>_to</code>。</p>
</li>
<li><p>骗你的，那不是最后一步。我们还需要再做一件事情。</p>
<p>ERC721规范包含了一个 <code>Transfer</code> 事件。这个函数的最后一行应该用正确的参数触发<code>Transfer</code> ——查看 <code>erc721.sol</code> 看它期望传入的参数并在这里实现。</p>
</li>
</ol>
<h2 id="合约完善-2"><a href="#合约完善-2" class="headerlink" title="合约完善"></a>合约完善</h2><p>ZombieOwnership.sol</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"./zombieattack.sol"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./erc721.sol"</span>;</span><br><span class="line"></span><br><span class="line">contract ZombieOwnership is ZombieAttack, ERC721 &#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _owner</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint256 _balance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ownerZombieCount[_owner];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">ownerOf</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">address _owner</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> zombieToOwner[_tokenId];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在这里定义 _transfer()</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_transfer</span>(<span class="params">address _from, address _to, uint256 _tokenId</span>) <span class="title">private</span> </span>&#123;</span><br><span class="line">      ownerZombieCount[_to]++;</span><br><span class="line">      ownerZombieCount[_from]--;</span><br><span class="line">      zombieToOwner[_tokenId] = _to;</span><br><span class="line">      Transfer(_from, _to, _tokenId);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">approve</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">takeOwnership</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ERC721-转移-续"><a href="#ERC721-转移-续" class="headerlink" title="ERC721: 转移-续"></a>ERC721: 转移-续</h1><p>太好了！刚才那是最难的部分——现在实现公共的 <code>transfer</code> 函数应该十分容易，因为我们的 <code>_transfer</code> 函数几乎已经把所有的重活都干完了。</p>
<h2 id="实战演习-5"><a href="#实战演习-5" class="headerlink" title="实战演习"></a>实战演习</h2><ol>
<li><p>我们想确保只有代币或僵尸的所有者可以转移它。还记得我们如何限制只有所有者才能访问某个功能吗？</p>
<p>没错，我们已经有一个修饰符能够完成这个任务了。所以将修饰符 <code>onlyOwnerOf</code> 添加到这个函数中。</p>
</li>
<li><p>现在该函数的正文只需要一行代码。它只需要调用 <code>_transfer</code>。</p>
<p>记得把 <code>msg.sender</code> 作为参数传递进 <code>address _from</code>。</p>
</li>
</ol>
<h2 id="合约完善-3"><a href="#合约完善-3" class="headerlink" title="合约完善"></a>合约完善</h2><p>ZombieOwnership.sol</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"./zombieattack.sol"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./erc721.sol"</span>;</span><br><span class="line"></span><br><span class="line">contract ZombieOwnership is ZombieAttack, ERC721 &#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _owner</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint256 _balance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ownerZombieCount[_owner];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">ownerOf</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">address _owner</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> zombieToOwner[_tokenId];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_transfer</span>(<span class="params">address _from, address _to, uint256 _tokenId</span>) <span class="title">private</span> </span>&#123;</span><br><span class="line">    ownerZombieCount[_to]++;</span><br><span class="line">    ownerZombieCount[_from]--;</span><br><span class="line">    zombieToOwner[_tokenId] = _to;</span><br><span class="line">    Transfer(_from, _to, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1. 在这里添加修饰符</span></span><br><span class="line">  <span class="comment">//function transfer(address _to, uint256 _tokenId) public &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span> <span class="title">onlyOwnerOf</span>(<span class="params">_tokenId</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 2. 在这里定义方法</span></span><br><span class="line">    _transfer(msg.sender, _to, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">approve</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">takeOwnership</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ERC721-批准"><a href="#ERC721-批准" class="headerlink" title="ERC721: 批准"></a>ERC721: 批准</h1><p>现在，让我们来实现 <code>approve</code>。</p>
<p>记住，使用 <code>approve</code> 或者 <code>takeOwnership</code> 的时候，转移有2个步骤：</p>
<ol>
<li>你，作为所有者，用新主人的 <code>address</code> 和你希望他获取的 <code>_tokenId</code> 来调用 <code>approve</code></li>
<li>新主人用 <code>_tokenId</code> 来调用 <code>takeOwnership</code>，合约会检查确保他获得了批准，然后把代币转移给他。</li>
</ol>
<p>因为这发生在2个函数的调用中，所以在函数调用之间，我们需要一个数据结构来存储什么人被批准获取什么。</p>
<h2 id="实战演习-6"><a href="#实战演习-6" class="headerlink" title="实战演习"></a>实战演习</h2><ol>
<li><p>首先，让我们来定义一个映射 <code>zombieApprovals</code>。它应该将一个 <code>uint</code> 映射到一个 <code>address</code>。</p>
<p>这样一来，当有人用一个 <code>_tokenId</code> 调用 <code>takeOwnership</code> 时，我们可以用这个映射来快速查找谁被批准获取那个代币。</p>
</li>
<li><p>在函数 <code>approve</code> 上， 我们想要确保只有代币所有者可以批准某人来获取代币。所以我们需要添加修饰符 <code>onlyOwnerOf</code> 到 <code>approve</code>。</p>
</li>
<li><p>函数的正文部分，将 <code>_tokenId</code> 的 <code>zombieApprovals</code> 设置为和 <code>_to</code> 相等。</p>
</li>
<li><p>最后，在 ERC721 规范里有一个 <code>Approval</code> 事件。所以我们应该在这个函数的最后触发这个事件。（参考 <code>erc721.sol</code> 来确认传入的参数，并确保 <code>_owner</code> 是 <code>msg.sender</code>）</p>
</li>
</ol>
<h2 id="合约完善-4"><a href="#合约完善-4" class="headerlink" title="合约完善"></a>合约完善</h2><p>ZombieOwnership.sol</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"./zombieattack.sol"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./erc721.sol"</span>;</span><br><span class="line"></span><br><span class="line">contract ZombieOwnership is ZombieAttack, ERC721 &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1. 在这里定义映射</span></span><br><span class="line">  mapping (<span class="function"><span class="params">uint</span> =&gt;</span> address) zombieApprovals;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _owner</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint256 _balance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ownerZombieCount[_owner];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">ownerOf</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">address _owner</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> zombieToOwner[_tokenId];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_transfer</span>(<span class="params">address _from, address _to, uint256 _tokenId</span>) <span class="title">private</span> </span>&#123;</span><br><span class="line">    ownerZombieCount[_to]++;</span><br><span class="line">    ownerZombieCount[_from]--;</span><br><span class="line">    zombieToOwner[_tokenId] = _to;</span><br><span class="line">    Transfer(_from, _to, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span> <span class="title">onlyOwnerOf</span>(<span class="params">_tokenId</span>) </span>&#123;</span><br><span class="line">    _transfer(msg.sender, _to, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. 在这里添加方法修饰符</span></span><br><span class="line">  <span class="comment">//function approve(address _to, uint256 _tokenId) public &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">approve</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span> <span class="title">onlyOwnerOf</span>(<span class="params">_tokenId</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 3. 在这里定义方法</span></span><br><span class="line">    zombieApprovals[_tokenId] = _to;</span><br><span class="line">    Approval(msg.sender, _to, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">takeOwnership</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ERC721-takeOwnership"><a href="#ERC721-takeOwnership" class="headerlink" title="ERC721: takeOwnership"></a>ERC721: takeOwnership</h1><p>太棒了，现在让我们完成最后一个函数来结束 ERC721 的实现。（别担心，这后面我们还会讲更多内容😉）</p>
<p>最后一个函数 <code>takeOwnership</code>， 应该只是简单地检查以确保 <code>msg.sender</code> 已经被批准来提取这个代币或者僵尸。若确认，就调用 <code>_transfer</code>；</p>
<h2 id="实战演习-7"><a href="#实战演习-7" class="headerlink" title="实战演习"></a>实战演习</h2><ol>
<li><p>首先，我们要用一个 <code>require</code> 句式来检查 <code>_tokenId</code> 的 <code>zombieApprovals</code> 和 <code>msg.sender</code> 相等。</p>
<p>这样如果 <code>msg.sender</code> 未被授权来提取这个代币，将抛出一个错误。</p>
</li>
<li><p>为了调用 <code>_transfer</code>，我们需要知道代币所有者的地址（它需要一个 <code>_from</code> 来作为参数）。幸运的是我们可以在我们的 <code>ownerOf</code> 函数中来找到这个参数。</p>
<p>所以，定义一个名为 <code>owner</code> 的 <code>address</code> 变量，并使其等于 <code>ownerOf(_tokenId)</code>。</p>
</li>
<li><p>最后，调用 <code>_transfer</code>, 并传入所有必须的参数。（在这里你可以用 <code>msg.sender</code> 作为 <code>_to</code>， 因为代币正是要发送给调用这个函数的人）。</p>
<blockquote>
<p>注意： 我们完全可以用一行代码来实现第2、3两步。但是分开写会让代码更易读。一点个人建议 :)</p>
</blockquote>
</li>
</ol>
<h2 id="合约完善-5"><a href="#合约完善-5" class="headerlink" title="合约完善"></a>合约完善</h2><p>ZombieOwnership.sol</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"./zombieattack.sol"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./erc721.sol"</span>;</span><br><span class="line"></span><br><span class="line">contract ZombieOwnership is ZombieAttack, ERC721 &#123;</span><br><span class="line"></span><br><span class="line">  mapping (<span class="function"><span class="params">uint</span> =&gt;</span> address) zombieApprovals;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _owner</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint256 _balance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ownerZombieCount[_owner];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">ownerOf</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">address _owner</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> zombieToOwner[_tokenId];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_transfer</span>(<span class="params">address _from, address _to, uint256 _tokenId</span>) <span class="title">private</span> </span>&#123;</span><br><span class="line">    ownerZombieCount[_to]++;</span><br><span class="line">    ownerZombieCount[_from]--;</span><br><span class="line">    zombieToOwner[_tokenId] = _to;</span><br><span class="line">    Transfer(_from, _to, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span> <span class="title">onlyOwnerOf</span>(<span class="params">_tokenId</span>) </span>&#123;</span><br><span class="line">    _transfer(msg.sender, _to, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">approve</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span> <span class="title">onlyOwnerOf</span>(<span class="params">_tokenId</span>) </span>&#123;</span><br><span class="line">    zombieApprovals[_tokenId] = _to;</span><br><span class="line">    Approval(msg.sender, _to, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">takeOwnership</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 从这里开始</span></span><br><span class="line">    <span class="built_in">require</span>(zombieApprovals[_tokenId] == msg.sender);</span><br><span class="line">    address owner = ownerOf(_tokenId);</span><br><span class="line">    _transfer(owner, msg.sender, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="预防溢出"><a href="#预防溢出" class="headerlink" title="预防溢出"></a>预防溢出</h1><p>恭喜你，我们完成了 ERC721 的实现。</p>
<p>并不是很复杂，对吧？很多类似的以太坊概念，当你只听人们谈论它们的时候，会觉得很复杂。所以最简单的理解方式就是你自己来实现它。</p>
<p>不过要记住那只是最简单的实现。还有很多的特性我们也许想加入到我们的实现中来，比如一些额外的检查，来确保用户不会不小心把他们的僵尸转移给<code>0</code> 地址（这被称作 “烧币”, 基本上就是把代币转移到一个谁也没有私钥的地址，让这个代币永远也无法恢复）。 或者在 DApp 中加入一些基本的拍卖逻辑。（你能想出一些实现的方法么？）</p>
<p>但是为了让我们的课程不至于离题太远，所以我们只专注于一些基础实现。如果你想学习一些更深层次的实现，可以在这个教程结束后，去看看 OpenZeppelin 的 ERC721 合约。</p>
<h2 id="合约安全增强-溢出和下溢"><a href="#合约安全增强-溢出和下溢" class="headerlink" title="合约安全增强: 溢出和下溢"></a>合约安全增强: 溢出和下溢</h2><p>我们将来学习你在编写智能合约的时候需要注意的一个主要的安全特性：防止溢出和下溢。</p>
<p>什么是 <strong><em>溢出</em></strong> (<strong><em>overflow\</em></strong>)?</p>
<p>假设我们有一个 <code>uint8</code>, 只能存储8 bit数据。这意味着我们能存储的最大数字就是二进制 <code>11111111</code> (或者说十进制的 2^8 - 1 = 255).</p>
<p>来看看下面的代码。最后 <code>number</code> 将会是什么值？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uint8 number = 255;</span><br><span class="line">number++;</span><br></pre></td></tr></table></figure>

<p>在这个例子中，我们导致了溢出 — 虽然我们加了1， 但是 <code>number</code> 出乎意料地等于 <code>0</code>了。 (如果你给二进制 <code>11111111</code> 加1, 它将被重置为 <code>00000000</code>，就像钟表从 <code>23:59</code> 走向 <code>00:00</code>)。</p>
<p>下溢(<code>underflow</code>)也类似，如果你从一个等于 <code>0</code> 的 <code>uint8</code> 减去 <code>1</code>, 它将变成 <code>255</code> (因为 <code>uint</code> 是无符号的，其不能等于负数)。</p>
<p>虽然我们在这里不使用 <code>uint8</code>，而且每次给一个 <code>uint256</code> 加 <code>1</code> 也不太可能溢出 (2^256 真的是一个很大的数了)，在我们的合约中添加一些保护机制依然是非常有必要的，以防我们的 DApp 以后出现什么异常情况。</p>
<h2 id="使用-SafeMath"><a href="#使用-SafeMath" class="headerlink" title="使用 SafeMath"></a>使用 SafeMath</h2><p>为了防止这些情况，OpenZeppelin 建立了一个叫做 SafeMath 的 <strong><em>库</em></strong>(<strong><em>library\</em></strong>)，默认情况下可以防止这些问题。</p>
<p>不过在我们使用之前…… 什么叫做库?</p>
<p>一个<strong><em>库</em></strong> 是 Solidity 中一种特殊的合约。其中一个有用的功能是给原始数据类型增加一些方法。</p>
<p>比如，使用 SafeMath 库的时候，我们将使用 <code>using SafeMath for uint256</code> 这样的语法。 SafeMath 库有四个方法 — <code>add</code>， <code>sub</code>， <code>mul</code>， 以及 <code>div</code>。现在我们可以这样来让 <code>uint256</code> 调用这些方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">using SafeMath for uint256;</span><br><span class="line"></span><br><span class="line">uint256 a = 5;</span><br><span class="line">uint256 b = a.add(3); // 5 + 3 = 8</span><br><span class="line">uint256 c = a.mul(2); // 5 * 2 = 10</span><br></pre></td></tr></table></figure>

<p>我们将在下一章来学习这些方法，不过现在我们先将 SafeMath 库添加进我们的合约。</p>
<h2 id="实战演习-8"><a href="#实战演习-8" class="headerlink" title="实战演习"></a>实战演习</h2><p>我们已经帮你把 OpenZeppelin 的 <code>SafeMath</code> 库包含进 <code>safemath.sol</code>了，如果你想看一下代码的话，现在可以看看，不过我们下一章将深入进去。</p>
<p>首先我们来告诉我们的合约要使用 SafeMath。我们将在我们的 <code>ZombieFactory</code> 里调用，这是我们的基础合约 — 这样其他所有继承出去的子合约都可以使用这个库了。</p>
<ol>
<li>将 <code>safemath.sol</code> 引入到 <code>zombiefactory.sol</code>.</li>
<li>添加定义： <code>using SafeMath for uint256;</code>.</li>
</ol>
<h2 id="合约修改-1"><a href="#合约修改-1" class="headerlink" title="合约修改"></a>合约修改</h2><p>ZombieFactory.sol</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"./ownable.sol"</span>;</span><br><span class="line"><span class="comment">// 1. 在这里引入</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"./safemath.sol"</span>;</span><br><span class="line"></span><br><span class="line">contract ZombieFactory is Ownable &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. 在这里定义 using safemath </span></span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">  event NewZombie(uint zombieId, string name, uint dna);</span><br><span class="line"></span><br><span class="line">  uint dnaDigits = <span class="number">16</span>;</span><br><span class="line">  uint dnaModulus = <span class="number">10</span> ** dnaDigits;</span><br><span class="line">  uint cooldownTime = <span class="number">1</span> days;</span><br><span class="line"></span><br><span class="line">  struct Zombie &#123;</span><br><span class="line">    string name;</span><br><span class="line">    uint dna;</span><br><span class="line">    uint32 level;</span><br><span class="line">    uint32 readyTime;</span><br><span class="line">    uint16 winCount;</span><br><span class="line">    uint16 lossCount;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Zombie[] public zombies;</span><br><span class="line"></span><br><span class="line">  mapping (<span class="function"><span class="params">uint</span> =&gt;</span> address) public zombieToOwner;</span><br><span class="line">  mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint) ownerZombieCount;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_createZombie</span>(<span class="params">string _name, uint _dna</span>) <span class="title">internal</span> </span>&#123;</span><br><span class="line">    uint id = zombies.push(Zombie(_name, _dna, <span class="number">1</span>, uint32(now + cooldownTime), <span class="number">0</span>, <span class="number">0</span>)) - <span class="number">1</span>;</span><br><span class="line">    zombieToOwner[id] = msg.sender;</span><br><span class="line">    ownerZombieCount[msg.sender]++;</span><br><span class="line">    NewZombie(id, _name, _dna);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_generateRandomDna</span>(<span class="params">string _str</span>) <span class="title">private</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">    uint rand = uint(keccak256(_str));</span><br><span class="line">    <span class="keyword">return</span> rand % dnaModulus;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">createRandomZombie</span>(<span class="params">string _name</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(ownerZombieCount[msg.sender] == <span class="number">0</span>);</span><br><span class="line">    uint randDna = _generateRandomDna(_name);</span><br><span class="line">    randDna = randDna - randDna % <span class="number">100</span>;</span><br><span class="line">    _createZombie(_name, randDna);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="SafeMath-第二部分"><a href="#SafeMath-第二部分" class="headerlink" title="SafeMath 第二部分"></a>SafeMath 第二部分</h1><p>来看看 SafeMath 的部分代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">library SafeMath &#123;</span><br><span class="line"></span><br><span class="line">  function mul(uint256 a, uint256 b) internal pure returns (uint256) &#123;</span><br><span class="line">    if (a == 0) &#123;</span><br><span class="line">      return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    uint256 c = a * b;</span><br><span class="line">    assert(c / a == b);</span><br><span class="line">    return c;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function div(uint256 a, uint256 b) internal pure returns (uint256) &#123;</span><br><span class="line">    // assert(b &gt; 0); // Solidity automatically throws when dividing by 0</span><br><span class="line">    uint256 c = a / b;</span><br><span class="line">    // assert(a == b * c + a % b); // There is no case in which this doesn&apos;t hold</span><br><span class="line">    return c;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function sub(uint256 a, uint256 b) internal pure returns (uint256) &#123;</span><br><span class="line">    assert(b &lt;= a);</span><br><span class="line">    return a - b;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function add(uint256 a, uint256 b) internal pure returns (uint256) &#123;</span><br><span class="line">    uint256 c = a + b;</span><br><span class="line">    assert(c &gt;= a);</span><br><span class="line">    return c;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先我们有了 <code>library</code> 关键字 — 库和 <code>合约</code>很相似，但是又有一些不同。 就我们的目的而言，库允许我们使用 <code>using</code> 关键字，它可以自动把库的所有方法添加给一个数据类型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">using SafeMath for uint;</span><br><span class="line">// 这下我们可以为任何 uint 调用这些方法了</span><br><span class="line">uint test = 2;</span><br><span class="line">test = test.mul(3); // test 等于 6 了</span><br><span class="line">test = test.add(5); // test 等于 11 了</span><br></pre></td></tr></table></figure>

<p>注意 <code>mul</code> 和 <code>add</code> 其实都需要两个参数。 在我们声明了 <code>using SafeMath for uint</code> 后，我们用来调用这些方法的 <code>uint</code> 就自动被作为第一个参数传递进去了(在此例中就是 <code>test</code>)</p>
<p>我们来看看 <code>add</code> 的源代码看 SafeMath 做了什么:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function add(uint256 a, uint256 b) internal pure returns (uint256) &#123;</span><br><span class="line">  uint256 c = a + b;</span><br><span class="line">  assert(c &gt;= a);</span><br><span class="line">  return c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基本上 <code>add</code> 只是像 <code>+</code> 一样对两个 <code>uint</code> 相加， 但是它用一个 <code>assert</code> 语句来确保结果大于 <code>a</code>。这样就防止了溢出。</p>
<p><code>assert</code> 和 <code>require</code> 相似，若结果为否它就会抛出错误。 <code>assert</code> 和 <code>require</code> 区别在于，<code>require</code> 若失败则会返还给用户剩下的 gas， <code>assert</code> 则不会。所以大部分情况下，你写代码的时候会比较喜欢 <code>require</code>，<code>assert</code> 只在代码可能出现严重错误的时候使用，比如 <code>uint</code> 溢出。</p>
<p>所以简而言之， SafeMath 的 <code>add</code>， <code>sub</code>， <code>mul</code>， 和 <code>div</code> 方法只做简单的四则运算，然后在发生溢出或下溢的时候抛出错误。</p>
<h2 id="在我们的代码里使用-SafeMath。"><a href="#在我们的代码里使用-SafeMath。" class="headerlink" title="在我们的代码里使用 SafeMath。"></a>在我们的代码里使用 SafeMath。</h2><p>为了防止溢出和下溢，我们可以在我们的代码里找 <code>+</code>， <code>-</code>， <code>*</code>， 或 <code>/</code>，然后替换为 <code>add</code>, <code>sub</code>, <code>mul</code>, <code>div</code>.</p>
<p>比如，与其这样做:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myUint++;</span><br></pre></td></tr></table></figure>

<p>我们这样做：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myUint = myUint.add(1);</span><br></pre></td></tr></table></figure>

<h2 id="实战演习-9"><a href="#实战演习-9" class="headerlink" title="实战演习"></a>实战演习</h2><p>在 <code>ZombieOwnership</code> 中有两个地方用到了数学运算，来替换成 SafeMath 方法把。</p>
<ol>
<li>将 <code>++</code> 替换成 SafeMath 方法。</li>
<li>将 <code>--</code> 替换成 SafeMath 方法。</li>
</ol>
<h2 id="合约修改-2"><a href="#合约修改-2" class="headerlink" title="合约修改"></a>合约修改</h2><p>zombieownership.sol</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"./zombieattack.sol"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./erc721.sol"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./safemath.sol"</span>;</span><br><span class="line"></span><br><span class="line">contract ZombieOwnership is ZombieAttack, ERC721 &#123;</span><br><span class="line"></span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line"></span><br><span class="line">  mapping (<span class="function"><span class="params">uint</span> =&gt;</span> address) zombieApprovals;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _owner</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint256 _balance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ownerZombieCount[_owner];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">ownerOf</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">address _owner</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> zombieToOwner[_tokenId];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_transfer</span>(<span class="params">address _from, address _to, uint256 _tokenId</span>) <span class="title">private</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 替换成 SafeMath 的 `add`</span></span><br><span class="line">    <span class="comment">//ownerZombieCount[_to]++;</span></span><br><span class="line">    ownerZombieCount[_to] = ownerZombieCount[_to].add(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 2. 替换成 SafeMath 的 `sub`</span></span><br><span class="line">    <span class="comment">//ownerZombieCount[_from]--;</span></span><br><span class="line">    ownerZombieCount[_from] = ownerZombieCount[_from].sub(<span class="number">1</span>);</span><br><span class="line">    zombieToOwner[_tokenId] = _to;</span><br><span class="line">    Transfer(_from, _to, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span> <span class="title">onlyOwnerOf</span>(<span class="params">_tokenId</span>) </span>&#123;</span><br><span class="line">    _transfer(msg.sender, _to, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">approve</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span> <span class="title">onlyOwnerOf</span>(<span class="params">_tokenId</span>) </span>&#123;</span><br><span class="line">    zombieApprovals[_tokenId] = _to;</span><br><span class="line">    Approval(msg.sender, _to, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">takeOwnership</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(zombieApprovals[_tokenId] == msg.sender);</span><br><span class="line">    address owner = ownerOf(_tokenId);</span><br><span class="line">    _transfer(owner, msg.sender, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="SafeMath-第三部分"><a href="#SafeMath-第三部分" class="headerlink" title="SafeMath 第三部分"></a>SafeMath 第三部分</h1><p>太好了，这下我们的 ERC721 实现不会有溢出或者下溢了。</p>
<p>回头看看我们在之前课程写的代码，还有其他几个地方也有可能导致溢出或下溢。</p>
<p>比如， 在 ZombieAttack 里面我们有：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">myZombie.winCount++;</span><br><span class="line">myZombie.level++;</span><br><span class="line">enemyZombie.lossCount++;</span><br></pre></td></tr></table></figure>

<p>我们同样应该在这些地方防止溢出。（通常情况下，总是使用 SafeMath 而不是普通数学运算是个好主意，也许在以后 Solidity 的新版本里这点会被默认实现，但是现在我们得自己在代码里实现这些额外的安全措施）。</p>
<p>不过我们遇到个小问题 — <code>winCount</code> 和 <code>lossCount</code> 是 <code>uint16</code>， 而 <code>level</code> 是 <code>uint32</code>。 所以如果我们用这些作为参数传入 SafeMath 的 <code>add</code> 方法。 它实际上并不会防止溢出，因为它会把这些变量都转换成 <code>uint256</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">uint256 a, uint256 b</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">  uint256 c = a + b;</span><br><span class="line">  assert(c &gt;= a);</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果我们在`uint8` 上调用 `.add`。它将会被转换成 `uint256`.</span></span><br><span class="line"><span class="comment">// 所以它不会在 2^8 时溢出，因为 256 是一个有效的 `uint256`.</span></span><br></pre></td></tr></table></figure>

<p>这就意味着，我们需要再实现两个库来防止 <code>uint16</code> 和 <code>uint32</code> 溢出或下溢。我们可以将其命名为 <code>SafeMath16</code> 和 <code>SafeMath32</code>。</p>
<p>代码将和 SafeMath 完全相同，除了所有的 <code>uint256</code> 实例都将被替换成 <code>uint32</code> 或 <code>uint16</code>。</p>
<p>我们已经将这些代码帮你写好了，打开 <code>safemath.sol</code> 合约看看代码吧。</p>
<p>现在我们需要在 ZombieFactory 里使用它们。</p>
<h2 id="Putting-it-to-the-Test"><a href="#Putting-it-to-the-Test" class="headerlink" title="Putting it to the Test"></a>Putting it to the Test</h2><p>分配：</p>
<ol>
<li>声明我们将为 <code>uint32</code> 使用<code>SafeMath32</code>。</li>
<li>声明我们将为 <code>uint16</code> 使用<code>SafeMath16</code>。</li>
<li>在 ZombieFactory 里还有一处我们也应该使用 SafeMath 的方法， 我们已经在那里留了注释提醒你。</li>
</ol>
<h2 id="合约修改-3"><a href="#合约修改-3" class="headerlink" title="合约修改"></a>合约修改</h2><p>zombiefactory.sol</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"./ownable.sol"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"./safemath.sol"</span>;</span><br><span class="line"></span><br><span class="line">contract ZombieFactory is Ownable &#123;</span><br><span class="line"></span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">  <span class="comment">// 1. 为 uint32 声明 使用 SafeMath32</span></span><br><span class="line">  using SafeMath32 <span class="keyword">for</span> uint32;</span><br><span class="line">  <span class="comment">// 2. 为 uint16 声明 使用 SafeMath16</span></span><br><span class="line">  using SafeMath16 <span class="keyword">for</span> uint16;</span><br><span class="line"></span><br><span class="line">  event NewZombie(uint zombieId, string name, uint dna);</span><br><span class="line"></span><br><span class="line">  uint dnaDigits = <span class="number">16</span>;</span><br><span class="line">  uint dnaModulus = <span class="number">10</span> ** dnaDigits;</span><br><span class="line">  uint cooldownTime = <span class="number">1</span> days;</span><br><span class="line"></span><br><span class="line">  struct Zombie &#123;</span><br><span class="line">    string name;</span><br><span class="line">    uint dna;</span><br><span class="line">    uint32 level;</span><br><span class="line">    uint32 readyTime;</span><br><span class="line">    uint16 winCount;</span><br><span class="line">    uint16 lossCount;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Zombie[] public zombies;</span><br><span class="line"></span><br><span class="line">  mapping (<span class="function"><span class="params">uint</span> =&gt;</span> address) public zombieToOwner;</span><br><span class="line">  mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint) ownerZombieCount;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_createZombie</span>(<span class="params">string _name, uint _dna</span>) <span class="title">internal</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 注意: 我们选择不处理2038年问题，所以不用担心 readyTime 的溢出</span></span><br><span class="line">    <span class="comment">// 反正在2038年我们的APP早完蛋了</span></span><br><span class="line">    uint id = zombies.push(Zombie(_name, _dna, <span class="number">1</span>, uint32(now + cooldownTime), <span class="number">0</span>, <span class="number">0</span>)) - <span class="number">1</span>;</span><br><span class="line">    zombieToOwner[id] = msg.sender;</span><br><span class="line">    <span class="comment">// 3. 在这里使用 SafeMath 的 `add` 方法:</span></span><br><span class="line">    <span class="comment">//ownerZombieCount[msg.sender]++;</span></span><br><span class="line">    ownerZombieCount[msg.sender] = ownerZombieCount[msg.sender].add(<span class="number">1</span>);</span><br><span class="line">    NewZombie(id, _name, _dna);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_generateRandomDna</span>(<span class="params">string _str</span>) <span class="title">private</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">    uint rand = uint(keccak256(_str));</span><br><span class="line">    <span class="keyword">return</span> rand % dnaModulus;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">createRandomZombie</span>(<span class="params">string _name</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(ownerZombieCount[msg.sender] == <span class="number">0</span>);</span><br><span class="line">    uint randDna = _generateRandomDna(_name);</span><br><span class="line">    randDna = randDna - randDna % <span class="number">100</span>;</span><br><span class="line">    _createZombie(_name, randDna);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="SafeMath-第4部分"><a href="#SafeMath-第4部分" class="headerlink" title="SafeMath 第4部分"></a>SafeMath 第4部分</h1><p>真棒，现在我们已经为我们的 DApp 里面用到的 <code>uint</code> 数据类型都实现了 SafeMath 了。</p>
<p>让我们把 <code>ZombieAttack</code> 里所有潜在的问题都修复了吧。 （其实在 <code>ZombieHelper</code> 里也有一处 <code>zombies[_zombieId].level++;</code> 需要修复，不过我们已经帮你做好了，这样我们就不用再来一章了 😉）。</p>
<h2 id="实战演习-10"><a href="#实战演习-10" class="headerlink" title="实战演习"></a>实战演习</h2><p>放心大胆去对 <code>ZombieAttack</code> 里所有的 <code>++</code> 操作都使用 SafeMath 方法吧。为了方便你找，我们已经在相应的地方留了注释给你。</p>
<h2 id="合约修改-4"><a href="#合约修改-4" class="headerlink" title="合约修改"></a>合约修改</h2><p>ZombieAttack .sol</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"./zombiehelper.sol"</span>;</span><br><span class="line"></span><br><span class="line">contract ZombieBattle is ZombieHelper &#123;</span><br><span class="line">  uint randNonce = <span class="number">0</span>;</span><br><span class="line">  uint attackVictoryProbability = <span class="number">70</span>;</span><br><span class="line">  <span class="comment">//using SafeMath for uint256;</span></span><br><span class="line">  <span class="comment">//using SafeMath32 for uint32;</span></span><br><span class="line">  <span class="comment">//using SafeMath16 for uint16;</span></span><br><span class="line">  <span class="comment">//ZombieBattle的父类是ZombieHelper，ZombieHelper的父类是ZombieFeeding，ZombieFeeding的父类是ZombieFactory。在ZombieFactory中引用过SafeMarh、SafeMarh32、SafeMarh16，所以在这里不需要重复引用。</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">randMod</span>(<span class="params">uint _modulus</span>) <span class="title">internal</span> <span class="title">returns</span>(<span class="params">uint</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 这儿有一个</span></span><br><span class="line">    <span class="comment">//randNonce++;</span></span><br><span class="line">    randNonce = randNonce.add(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> uint(keccak256(now, msg.sender, randNonce)) % _modulus;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">attack</span>(<span class="params">uint _zombieId, uint _targetId</span>) <span class="title">external</span> <span class="title">onlyOwnerOf</span>(<span class="params">_zombieId</span>) </span>&#123;</span><br><span class="line">    Zombie storage myZombie = zombies[_zombieId];</span><br><span class="line">    Zombie storage enemyZombie = zombies[_targetId];</span><br><span class="line">    uint rand = randMod(<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">if</span> (rand &lt;= attackVictoryProbability) &#123;</span><br><span class="line">      <span class="comment">// 这里有三个</span></span><br><span class="line">      <span class="comment">//myZombie.winCount++;</span></span><br><span class="line">      myZombie.winCount = myZombie.winCount.add(<span class="number">1</span>);</span><br><span class="line">      <span class="comment">//myZombie.level++;</span></span><br><span class="line">      myZombie.level = myZombie.level.add(<span class="number">1</span>);</span><br><span class="line">      <span class="comment">//enemyZombie.lossCount++;</span></span><br><span class="line">      enemyZombie.lossCount = enemyZombie.lossCount.add(<span class="number">1</span>);</span><br><span class="line">      feedAndMultiply(_zombieId, enemyZombie.dna, <span class="string">"zombie"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 这儿还有俩哦</span></span><br><span class="line">      <span class="comment">//myZombie.lossCount++;</span></span><br><span class="line">      myZombie.lossCount = myZombie.lossCount.add(<span class="number">1</span>);</span><br><span class="line">      <span class="comment">//enemyZombie.winCount++;</span></span><br><span class="line">      enemyZombie.winCount = enemyZombie.winCount.add(<span class="number">1</span>);</span><br><span class="line">      _triggerCooldown(myZombie);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h1><p>僵尸游戏的 Solidity 代码终于完成啦。</p>
<p>在以后的课程中，我们将学习如何将游戏部署到以太坊，以及如何和 Web3.js 交互。</p>
<p>不过在你离开第五课之前，我们来谈谈如何 <strong>给你的代码添加注释</strong>.</p>
<h2 id="注释语法"><a href="#注释语法" class="headerlink" title="注释语法"></a>注释语法</h2><p>Solidity 里的注释和 JavaScript 相同。在我们的课程中你已经看到了不少单行注释了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// 这是一个单行注释，可以理解为给自己或者别人看的笔记</span><br></pre></td></tr></table></figure>

<p>只要在任何地方添加一个 <code>//</code> 就意味着你在注释。如此简单所以你应该经常这么做。</p>
<p>不过我们也知道你的想法：有时候单行注释是不够的。毕竟你生来话痨。</p>
<p>所以我们有了多行注释：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">contract CryptoZombies &#123; </span><br><span class="line">  /* 这是一个多行注释。我想对所有花时间来尝试这个编程课程的人说声谢谢。</span><br><span class="line">  它是免费的，并将永远免费。但是我们依然倾注了我们的心血来让它变得更好。</span><br><span class="line"></span><br><span class="line">   要知道这依然只是区块链开发的开始而已，虽然我们已经走了很远，</span><br><span class="line">   仍然有很多种方式来让我们的社区变得更好。</span><br><span class="line">   如果我们在哪个地方出了错，欢迎在我们的 github 提交 PR 或者 issue 来帮助我们改进：</span><br><span class="line">    https://github.com/loomnetwork/cryptozombie-lessons</span><br><span class="line"></span><br><span class="line">    或者，如果你有任何的想法、建议甚至仅仅想和我们打声招呼，欢迎来我们的电报群：</span><br><span class="line">     https://t.me/loomnetworkcn</span><br><span class="line">  */</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>特别是，最好为你合约中每个方法添加注释来解释它的预期行为。这样其他开发者（或者你自己，在6个月以后再回到这个项目中）可以很快地理解你的代码而不需要逐行阅读所有代码。</p>
<p>Solidity 社区所使用的一个标准是使用一种被称作 <strong><em>natspec\</em></strong> 的格式，看起来像这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/// @title 一个简单的基础运算合约</span><br><span class="line">/// @author H4XF13LD MORRIS 💯💯😎💯💯</span><br><span class="line">/// @notice 现在，这个合约只添加一个乘法</span><br><span class="line">contract Math &#123;</span><br><span class="line">  /// @notice 两个数相乘</span><br><span class="line">  /// @param x 第一个 uint</span><br><span class="line">  /// @param y  第二个 uint</span><br><span class="line">  /// @return z  (x * y) 的结果</span><br><span class="line">  /// @dev 现在这个方法不检查溢出</span><br><span class="line">  function multiply(uint x, uint y) returns (uint z) &#123;</span><br><span class="line">    // 这只是个普通的注释，不会被 natspec 解释</span><br><span class="line">    z = x * y;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@title</code>（标题） 和 <code>@author</code> （作者）很直接了.</p>
<p><code>@notice</code> （须知）向 <strong>用户</strong> 解释这个方法或者合约是做什么的。 <code>@dev</code> （开发者） 是向开发者解释更多的细节。</p>
<p><code>@param</code> （参数）和 <code>@return</code> （返回） 用来描述这个方法需要传入什么参数以及返回什么值。</p>
<p>注意你并不需要每次都用上所有的标签，它们都是可选的。不过最少，写下一个 <code>@dev</code> 注释来解释每个方法是做什么的。</p>
<h2 id="实战演习-11"><a href="#实战演习-11" class="headerlink" title="实战演习"></a>实战演习</h2><p>如果你还没注意到：CryptoZombies 的答案检查器在工作的时候将忽略所有的注释。所以这一章我们其实无法检查你的 natspec 注释了。全靠你自己咯。</p>
<p>话说回来，到现在你应该已经是一个 Solidity 小能手了。我们就假定你已经学会这些了。</p>
<p>大胆去做些尝试把，给 <code>ZombieOwnership</code> 加上一些 natspec 标签:</p>
<ol>
<li><code>@title</code> — 例如：一个管理转移僵尸所有权的合约</li>
<li><code>@author</code> — 你的名字</li>
<li><code>@dev</code> — 例如：符合 OpenZeppelin 对 ERC721 标准草案的实现</li>
</ol>
<h1 id="放在一起"><a href="#放在一起" class="headerlink" title="放在一起"></a>放在一起</h1><p>恭喜你！这些就是第五课的全部啦。</p>
<p>作为奖赏，我们送给你了一个10级僵尸：<strong>H4XF13LD MORRIS 💯💯😎💯💯</strong> ！</p>
<p>（天啊，传奇的<strong>H4XF13LD MORRIS 💯💯😎💯💯</strong> 僵尸！）</p>
<p>这下你的僵尸大军有4个僵尸啦。</p>
<p>在你继续前，你可以点击每个僵尸来给它们起一个新名字， （注： <strong>H4XF13LD MORRIS 💯💯😎💯💯</strong> 这个梗来自于一个在2000年左右流行的古老游戏，我们的开发者觉得它很酷，你也可以给它起一个你觉得很酷的名字，比如“隔壁老王”或者“绿帽僵尸”😏）。</p>
<h2 id="总结一下"><a href="#总结一下" class="headerlink" title="总结一下"></a>总结一下</h2><p>这节课里面我们学到了</p>
<ul>
<li>代币, ERC721 标准，以及可交易的物件/僵尸</li>
<li>库以及如何使用库</li>
<li>如何利用 SafeMath 来防止溢出和下溢</li>
<li>代码注释和 natspec 标准</li>
</ul>
<p>这节教程完成了我们游戏的 Solidity 代码（仅针对当下来说，未来的课程我们也许会加入更多进去）。</p>
<p>在接下来的两节课中，我们将学习如何将游戏部署到以太坊以及和 <strong><em>web3.js\</em></strong> 交互 （这样你就能为你的 DApp 打造一个界面了 ）。</p>
<p>继续玩儿或者重命名你的僵尸，然后就可以点击下一章来结束本节教程了。</p>
<p><img src="https://i.loli.net/2020/06/29/OwCBJ4kfo8W9RpM.png" alt="image-20200629232202703"></p>
<h1 id="第五课打卡"><a href="#第五课打卡" class="headerlink" title="第五课打卡"></a>第五课打卡</h1><p><img src="https://i.loli.net/2020/06/29/Rt1SieE7unND4zc.png" alt="image-20200629233354077"></p>
<p><a href="https://share.cryptozombies.io/zh/lesson/5/share/H4XF13LD_MORRIS_%F0%9F%92%AF%F0%9F%92%AF%F0%9F%98%8E%F0%9F%92%AF%F0%9F%92%AF" target="_blank" rel="noopener">我的僵尸大军5</a></p>

    </div>

    
    
    
      
        <div class="reward-container">
  <div>您的支持是我继续创作的动力</div>
  <button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="李松柏 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="李松柏 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>李松柏
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://lisongbai.top/2020/06/29/ERC721%E6%A0%87%E5%87%86%E5%92%8C%E5%8A%A0%E5%AF%86%E6%94%B6%E8%97%8F%E5%93%81/" title="ERC721标准和加密收藏品">http://lisongbai.top/2020/06/29/ERC721%E6%A0%87%E5%87%86%E5%92%8C%E5%8A%A0%E5%AF%86%E6%94%B6%E8%97%8F%E5%93%81/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/null" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/solidity/" rel="tag"># solidity</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/2020/06/27/%E5%83%B5%E5%B0%B8%E4%BD%9C%E6%88%98%E7%B3%BB%E7%BB%9F/" rel="next" title="僵尸作战系统">
                  <i class="fa fa-chevron-left"></i> 僵尸作战系统
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/2020/06/30/web3-js/" rel="prev" title="web3.js">
                  web3.js <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-livere">livere</a></li>
            <li class="tab"><a href="#comment-disqus">disqus</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane livere" id="comment-livere">
              
  <div class="comments" id="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC80NzY2MC8yNDE1OA=="></div>
  </div>
  
            </div>
            <div class="tab-pane disqus" id="comment-disqus">
              
  <div class="comments" id="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  
            </div>
        </div>
      </div>
      <script>
        window.addEventListener('tabs:register', () => {
          let activeClass = '';
            activeClass = localStorage.getItem('comments_active') || activeClass;
          if (activeClass) {
            let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
            if (activeTab) {
              activeTab.click();
            }
          }
        });
        window.addEventListener('tabs:click', event => {
          let commentClass = event.target.classList[1];
          localStorage.setItem('comments_active', commentClass);
        });
      </script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#以太坊上的代币"><span class="nav-number">1.</span> <span class="nav-text">以太坊上的代币</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#它为什么重要呢？"><span class="nav-number">1.1.</span> <span class="nav-text">它为什么重要呢？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他代币标准"><span class="nav-number">1.2.</span> <span class="nav-text">其他代币标准</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习"><span class="nav-number">1.3.</span> <span class="nav-text">实战演习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#合约创建"><span class="nav-number">1.4.</span> <span class="nav-text">合约创建</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ERC721-标准-多重继承"><span class="nav-number">2.</span> <span class="nav-text">ERC721 标准, 多重继承</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#实现一个代币合约"><span class="nav-number">2.1.</span> <span class="nav-text">实现一个代币合约</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习-1"><span class="nav-number">2.2.</span> <span class="nav-text">实战演习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#合约完善"><span class="nav-number">2.3.</span> <span class="nav-text">合约完善</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#balanceOf-和-ownerOf"><span class="nav-number">3.</span> <span class="nav-text">balanceOf 和 ownerOf</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#balanceOf"><span class="nav-number">3.1.</span> <span class="nav-text">balanceOf</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ownerOf"><span class="nav-number">3.2.</span> <span class="nav-text">ownerOf</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习-2"><span class="nav-number">3.3.</span> <span class="nav-text">实战演习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#合约完善-1"><span class="nav-number">3.4.</span> <span class="nav-text">合约完善</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#重构"><span class="nav-number">4.</span> <span class="nav-text">重构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习-3"><span class="nav-number">4.1.</span> <span class="nav-text">实战演习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#合约修改"><span class="nav-number">4.2.</span> <span class="nav-text">合约修改</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ERC721-转移标准"><span class="nav-number">5.</span> <span class="nav-text">ERC721: 转移标准</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习-4"><span class="nav-number">5.1.</span> <span class="nav-text">实战演习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#合约完善-2"><span class="nav-number">5.2.</span> <span class="nav-text">合约完善</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ERC721-转移-续"><span class="nav-number">6.</span> <span class="nav-text">ERC721: 转移-续</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习-5"><span class="nav-number">6.1.</span> <span class="nav-text">实战演习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#合约完善-3"><span class="nav-number">6.2.</span> <span class="nav-text">合约完善</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ERC721-批准"><span class="nav-number">7.</span> <span class="nav-text">ERC721: 批准</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习-6"><span class="nav-number">7.1.</span> <span class="nav-text">实战演习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#合约完善-4"><span class="nav-number">7.2.</span> <span class="nav-text">合约完善</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ERC721-takeOwnership"><span class="nav-number">8.</span> <span class="nav-text">ERC721: takeOwnership</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习-7"><span class="nav-number">8.1.</span> <span class="nav-text">实战演习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#合约完善-5"><span class="nav-number">8.2.</span> <span class="nav-text">合约完善</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#预防溢出"><span class="nav-number">9.</span> <span class="nav-text">预防溢出</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#合约安全增强-溢出和下溢"><span class="nav-number">9.1.</span> <span class="nav-text">合约安全增强: 溢出和下溢</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用-SafeMath"><span class="nav-number">9.2.</span> <span class="nav-text">使用 SafeMath</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习-8"><span class="nav-number">9.3.</span> <span class="nav-text">实战演习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#合约修改-1"><span class="nav-number">9.4.</span> <span class="nav-text">合约修改</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SafeMath-第二部分"><span class="nav-number">10.</span> <span class="nav-text">SafeMath 第二部分</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#在我们的代码里使用-SafeMath。"><span class="nav-number">10.1.</span> <span class="nav-text">在我们的代码里使用 SafeMath。</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习-9"><span class="nav-number">10.2.</span> <span class="nav-text">实战演习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#合约修改-2"><span class="nav-number">10.3.</span> <span class="nav-text">合约修改</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SafeMath-第三部分"><span class="nav-number">11.</span> <span class="nav-text">SafeMath 第三部分</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Putting-it-to-the-Test"><span class="nav-number">11.1.</span> <span class="nav-text">Putting it to the Test</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#合约修改-3"><span class="nav-number">11.2.</span> <span class="nav-text">合约修改</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SafeMath-第4部分"><span class="nav-number">12.</span> <span class="nav-text">SafeMath 第4部分</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习-10"><span class="nav-number">12.1.</span> <span class="nav-text">实战演习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#合约修改-4"><span class="nav-number">12.2.</span> <span class="nav-text">合约修改</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#注释"><span class="nav-number">13.</span> <span class="nav-text">注释</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#注释语法"><span class="nav-number">13.1.</span> <span class="nav-text">注释语法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实战演习-11"><span class="nav-number">13.2.</span> <span class="nav-text">实战演习</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#放在一起"><span class="nav-number">14.</span> <span class="nav-text">放在一起</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#总结一下"><span class="nav-number">14.1.</span> <span class="nav-text">总结一下</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第五课打卡"><span class="nav-number">15.</span> <span class="nav-text">第五课打卡</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="李松柏"
    src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">李松柏</p>
  <div class="site-description" itemprop="description">记录学习的技能和遇到的问题</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">56</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/yym08090809" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;yym08090809" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:songbai0112@163.com" title="E-Mail &amp;rarr; mailto:songbai0112@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/null" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李松柏</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.4.2
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>






  <script>
  function leancloudSelector(url) {
    return document.getElementById(url).querySelector('.leancloud-visitors-count');
  }
  if (CONFIG.page.isPost) {
    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = visitors.getAttribute('id').trim();
      var title = visitors.getAttribute('data-flag-title').trim();

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .then(response => response.json())
              .then(() => {
                leancloudSelector(url).innerText = counter.time + 1;
              })
              .catch(error => {
                console.log('Failed to save visitor count', error);
              })
          } else {
              leancloudSelector(url).innerText = 'Counter not initialized! More info at console err msg.';
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .catch(error => {
          console.log('LeanCloud Counter Error', error);
        });
    }
  } else {
    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return element.getAttribute('id').trim();
      });

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url: { '$in': entries } })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length === 0) {
            document.querySelectorAll('.leancloud_visitors .leancloud-visitors-count').forEach(element => {
              element.innerText = 0;
            });
            return;
          }
          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.url;
            var time = item.time;
            leancloudSelector(url).innerText = time;
          }
          for (var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = leancloudSelector(url);
            if (element.innerText == '') {
              element.innerText = 0;
            }
          }
        })
        .catch(error => {
          console.log('LeanCloud Counter Error', error);
        });
    }
  }

  fetch('https://app-router.leancloud.cn/2/route?appId=')
    .then(response => response.json())
    .then(({ api_server }) => {
      var Counter = (method, url, data) => {
        return fetch(`https://${api_server}/1.1${url}`, {
          method: method,
          headers: {
            'X-LC-Id': '',
            'X-LC-Key': '',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        const localhost = /http:\/\/(localhost|127.0.0.1|0.0.0.0)/;
        if (localhost.test(document.URL)) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    });
  </script>






        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>













  

  

<script>
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
</script>

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://visitor.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  function loadComments() {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "http://lisongbai.top/2020/06/29/ERC721%E6%A0%87%E5%87%86%E5%92%8C%E5%8A%A0%E5%AF%86%E6%94%B6%E8%97%8F%E5%93%81/",
            identifier: "2020/06/29/ERC721标准和加密收藏品/",
            title: "ERC721标准和加密收藏品"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://visitor.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  }
    window.addEventListener('load', loadComments, false);
</script>

 
</body>
</html>
